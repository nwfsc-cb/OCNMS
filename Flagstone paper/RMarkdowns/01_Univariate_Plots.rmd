---
title: "Multivariate Analyses for Fish and Inverts"
author: Nick Toimieri
date: sys.date()
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
fontsize: 11pt

---

```{r SETUP, include=FALSE}
# A bunch of initial set up junk

rm(list = ls())

##### knitr stuff and libraries ####

HomeFile = getwd()
Fig_Loc = paste0(HomeFile,"/Figures/")
Data_Loc = paste0(HomeFile,"/Data/")
Results_Loc = paste0(HomeFile,"/Results/")
Other_Files = paste0(HomeFile,"/Other Files/")

# tools in use 
library(knitr)
# library(tidyr)
# library(dplyr)
library(tidyverse)
library(stringr)
# library(tinytex)
library(RColorBrewer)
# display.brewer.all(colorblindFriendly = TRUE)
library(readxl)

# stats packages etc
library(vegan)
library(BiodiversityR)
library(pracma)
library(factoextra)

# options
knitr::opts_chunk$set(
  fig.path = Fig_Loc,
  cache.path = 'cache/graphics-', 
  echo=FALSE,
  error=FALSE,
  include = TRUE,
  dev='png',
  dpi=300,
  warning=FALSE,
  #out.width = '100%',
  fig.align='center'
  
  )
# opts_knit$set(eval.after = "fig.cap")

# just to keep track of when I ran things.

Last_Run0 = Sys.time()
Last_Run = str_replace(Last_Run0, ":", ".")
Last_Run = str_replace(Last_Run, ":", ".")
capture.output(Last_Run, file = 'Last_Run.txt')

par(ps=10, cex=1)

source("R-functions-ocnms.r")

```

```{r triggers-and-settings}
min.vis = 2.0
years = 2015:2021
pch = c(9, 4, 8 , 21, 22, 24, 25 )
col = RColorBrewer::brewer.pal(n = 12, name = "Paired")[c(2,4,6,10,12,7,8)]
year.pch = data.frame(cbind(years, pch,col))

sites = c("Neah Bay","Tatoosh Island","Cape Alava","Cape Johnson","Destruction Island")
col = RColorBrewer::brewer.pal(n = 12, name = "Paired")[c(2,4,6, 10,12)]
site.col = data.frame(cbind(sites,col))
colnames(site.col) <- c('site', 'col')

spp_code = data.frame(read.csv('spp_codes.csv'))

#### species depths #####

kelp.depth = 5
fish.depth = c(5,10)
invert.depth = 5

###########################
```



# Import and manipulate data a bit

For the fish data 

* There is some renaming of things and lumping all SEFL and SEBYT yoy into just YTBLyoy
* Put in some fake visibility data for 2015. By my recollection, Destruction Island was horrible in 2015. So we should drop it for the fish data. 
* Then select only sites with visibility of 2.0 or greater.
* Finally, subset out only the five (5) sites for analyses.


Fish Depth = `r fish.depth` meters
Kelp Depth = `r kelp.depth` meters
Invert Depth = `r invert.depth` meters  

```{r fish-import-rds }
# import fish data. wide format

# read in rds file with combined data
fish0 = readRDS( paste0(Data_Loc,'Fish_2015-2021.rds' ))

# fix a spp name
fish0$species[ fish0$species == 'SEBYT'] <- 'SEFL'

# add in taxa groupings
# add in yoy designator and fix some names

taxa = spp_code$group[ match(fish0$species, spp_code$code)]

taxa1 <- ifelse( is.na(fish0$size_class)==TRUE, taxa, 
                       ifelse(fish0$size_class == "small", paste0(taxa,"yoy"), taxa))
fish0$taxa <- taxa1
fish0$taxa[ fish0$taxa == "RYOYyoy"] <- 'RYOY'

# combine YT and black or keep separate?
fish0$taxa[ fish0$taxa %in% c('SEFLyoy','SEMEyoy')] <- 'YTBLyoy'

# subset visibility
# add fake vis for 2015
fish0$vis_m[ fish0$year == 2015 ] <- 3
# poor vis at destruction in year 1.
fish0$vis_m[ fish0$year == 2015 & fish0$site == "Destruction Island"] <- 1

# output for multivariate 
saveRDS(fish0, paste0(Data_Loc, "Fish_2015-2021-ntmods.rds"))

# get just five sites

fish1 = fish0[ fish0$site %in% c("Destruction Island", "Cape Johnson","Cape Alava","Tatoosh Island","Neah Bay"),]

# drop low vis sites/transects
fish1a = fish1[fish1$vis_m >= min.vis, ]

# set depth

fish1b = fish1a[fish1a$zone %in% fish.depth,]

# calculate total yoy
x = fish1b[ fish1b$taxa %in% c("SECAyoy","SEPIyoy", "YTBLyoy", "RYOY"),]
x$taxa = 'totYOY'
x$species = 'totYOY'
x$common.name = "total rockfish yoy"
tyoy = aggregate(Count ~ . , data = x, FUN = sum)
tyoy = tyoy[,colnames(x)]                 

fish1c = rbind(fish1b , tyoy)

# double check specific averaging process here 

fish2 = aggregate( Count ~ site + zone + year + taxa, data = fish1c, FUN = mean )
colnames(fish2)[ncol(fish2)] <- 'mean'
fish = Sum_Stats('mean ~ year +  taxa', fish2)
fish$se_lo = fish$mean - fish$se
fish$se_up = fish$mean + fish$se

```

# Time series

1. There are multiple size classes. Data are first summed by transect for each spp.
2. Take the log(x+1) mean for site x year
3. Take the mean of #2 for year. So, the mean of sites
4. plotted data are log(x+1)
5. Additional output not in this file shows species abundance by year x site or year x site x depth just to look.

## Fish

Fish depth = `r fish.depth`

```{r fish-ts-2pane, fig.width=4.5, fig.height=5}

library(ggplot2)
library(gtable)
library(gridExtra)


fish.ylabel = "No. per transect"
all.colors =  RColorBrewer::brewer.pal(n = 12, name = "Paired")
fish.col = all.colors[ c(3,4,8,12,11,11,2) ]
fish.col[6] <- 'black'
yoy.col = all.colors[c(10,12,6,6,'black')]
yoy.col[4] <- 'black'  
     
uni.fish = fish[ fish$taxa %in% c("OPEL", "HEXA", "SECA", "SCMA" ,"SENE", "SEME", "SEFL"),]    

fish.plot = species.plot(uni.fish, group.var = 'taxa', years = 2015:2021, 
                     Ylim = NA, Ylab = fish.ylabel , Colors = fish.col)

yoy.fish = fish[ fish$taxa %in% c("SECAyoy","SEPIyoy", "YTBLyoy", "RYOY", "totYOY"),]


yoy.plot = species.plot(yoy.fish, group.var = 'taxa', years = 2015:2021, 
                     Ylab = fish.ylabel ,Ylim = NA, Colors = yoy.col)

g2 <- ggplotGrob(fish.plot)
g3 <- ggplotGrob(yoy.plot)
g <- rbind(g2, g3, size = "first")

g$widths <- grid::unit.pmax(g2$widths, g3$widths)
grid::grid.newpage()
grid::grid.draw(g)


```

A second version splitting out the SEME (blacks) because they are abundant.

```{r fish-ts-4pane, fig.width=4.5, fig.height=6}
library(ggplot2)
library(gtable)
library(gridExtra)

all.colors =  RColorBrewer::brewer.pal(n = 12, name = "Paired")
fish.col = all.colors[ c(3,4,8,12,11,2) ]
yoy.col = all.colors[c(10,12,6,4)]

uni.fish2 = fish[ fish$taxa %in% c("OPEL", "HEXA", "SECA", "SCMA" ,"SENE", "SEFL"),] 
yoy.fish2 = fish[ fish$taxa %in% c("SECAyoy","SEPIyoy", "RYOY"),]

fish.plot = species.plot(uni.fish2, group.var = 'taxa', years = 2015:2021, 
                     Ylim = NA, Ylab = fish.ylabel, Colors = fish.col )
yoy.plot = species.plot(yoy.fish2, group.var = 'taxa', years = 2015:2021, 
                     Ylab = fish.ylabel,Ylim = NA, Colors = yoy.col)

black = species.plot(fish[fish$taxa =="SEME",], group.var = 'taxa', years = 2015:2021, 
                     Ylim = NA, Ylab = fish.ylabel, Colors = 'black')
ytbl = species.plot(fish[fish$taxa %in% c("totYOY","YTBLyoy"),], group.var = 'taxa', years = 2015:2021, 
                     Ylim = NA, Ylab = fish.ylabel, Colors = c('darkgrey', "black") )

g1 <- ggplotGrob(black)
g3 <- ggplotGrob(ytbl)
g2 <- ggplotGrob(fish.plot)
g4 <- ggplotGrob(yoy.plot)

g <- rbind(g1, g2, g3, g4, size = "first")

g$widths <- grid::unit.pmax(g1$widths, g2$width, g2$widths, g4$widths)
grid::grid.newpage()
grid::grid.draw(g)
# grid.arrange(g1, g2, g3, g4, ncol=2, nrow =2)

```
## Swath: Kelp & Inverts

Kelp depth = `r kelp.depth`

```{r swath-alage}

swath0 = readRDS( paste0( Data_Loc,'Swath_2015-2021.rds' ))

swath1 = aggregate( Count ~  site  + year + zone + species + group , data=swath0, FUN = mean)
colnames(swath1)[ncol(swath1)] <- 'mean'
swath1$mean = as.numeric(swath1$mean)
# swath  = aggregate( Count ~ year + species + group , data = swath1, FUN = mean)

### kelp depth selection ####
swath2 = swath1[ swath1$zone %in% kelp.depth,]

# algae 5 m depth only

algae = Sum_Stats('mean ~ year + species + group' , swath2[swath2$species %in% c("MACPYR", "NERLUE", "PTECAL"),] )
algae$se_up = algae$mean+algae$se
algae$se_lo = algae$mean-algae$se
```

Invert depth = `r invert.depth`

```{r swath-invets}
# bring in swath. Same as algae data

swath0 = readRDS( paste0( Data_Loc,'Swath_2015-2021.rds' ))

urchins = c('MESFRA', 'STRPUR', 'STRDRO')
stars =   c('PISOCH','PISBRE', 'PISGIG','DERIMB','PYCHEL')
anenome = c('URTSPP', 'URTLOF', 'URTPIS','URTCRA', 'METSPP' , 'METGIG', 'ANTXAN','ANTELE')
cucs    = c('CUCMIN','PARCAL', 'EUPQUI')

swath0$taxa = swath0$species
swath0$taxa[swath0$taxa %in% c('PISOCH','PISBRE', 'PISGIG')] <- 'PISAST'
swath0$taxa[swath0$taxa %in% anenome] <- 'ANENOM'
swath0$taxa[swath0$taxa %in% c('CUCMIN','PARCAL', 'EUPQUI')] <- 'CUCUMB'

invert.spp = c(urchins, stars, anenome, cucs)

invert1 = aggregate( Count ~ site + zone + year + species + taxa , 
                     data = swath0[swath0$species %in% invert.spp, ], FUN = mean)
# invert1$zone = as.character(invert1$zone)

colnames(invert1)[ncol(invert1)] <- 'mean'
invert2 = invert1[invert1$zone %in% invert.depth,]

inverts =  Sum_Stats(' mean~ year + taxa' , invert2)
inverts$se_up = inverts$mean + inverts$se
inverts$se_lo = inverts$mean - inverts$se

```


```{r kelp-invert-ts , fig.width= 4.5 , fig.height= 6 }

kelp.col = all.colors[c(2,4,6)]
urchin.col = all.colors[c(6,4,10)]
invert.col = all.colors[c(2,4,6,8,10)]
     
algae.plot  = species.plot(algae, group.var = 'species', years = 2015:2021, 
                     Ylim = NA, Ylab = "Stipes per transect" , Colors = kelp.col)
x = inverts[inverts$taxa %in% urchins,]
urchin.plot =  species.plot(inverts[inverts$taxa %in% urchins,], group.var = 'taxa', years = 2015:2021, 
                     Ylim = NA, Ylab = "No. per transect", Colors = urchin.col )

inverts.plot =  species.plot(inverts[inverts$taxa %in% c('PISAST','PYCHEL','DERIMB','ANENOM','CUCUMB'),], group.var = 'taxa', years = 2015:2021, Ylim = NA, Ylab = "No. per transect" , Colors = invert.col)


g1 <- ggplotGrob(algae.plot)
g2 <- ggplotGrob(urchin.plot)
g3 <- ggplotGrob(inverts.plot)

g <- rbind(g1, g2, g3, size = "first")

g$widths <- grid::unit.pmax(g1$widths, g2$widths, g2$widths)
grid::grid.newpage()
grid::grid.draw(g)
# grid.arrange(g1, g2, g3, g4, ncol=1, nrow =4)
```

# EXTRA FIGURES - Univariate Plots just to see

Not plotted here but output. Outputted to a subfolder for perusal.
```{r run-additional-figures}

run.additional.figures = FALSE

```

## Site x Year

```{r, univariate-plots-fish}

if(run.additional.figures == TRUE){


new.file = paste0(Fig_Loc,"Fish-Site-x-Year/")
dir.create(new.file)
# fish1 does not delete low vis data

fish.log = aggregate( log(Count+1) ~ site + year +  taxa , data = fish1, FUN = mean )
colnames(fish.log)[ncol(fish.log)] <- 'mean'

fish.mean = aggregate( Count ~ site + year +  taxa , data = fish1, FUN = mean )
colnames(fish.mean)[ncol(fish.mean)] <- 'mean'

spp = as.character(levels(as.factor(fish.log$taxa)))

for(i in 1:length(spp)){
     graphics.off()
     
     jpeg(paste0(new.file,spp[i],"-site_by_year.jpg"))
     df1 = fish.log[fish.log$taxa==spp[i],]
     plot1 = species.plot.SxY(data.file = df1, Ylab = 'Log(x+1)')
     
     df2 = fish.mean[fish.mean$taxa==spp[i],]
     plot2 = species.plot.SxY(data.file = df2, Ylab = 'Arith.Mean')
     
     g1 <- ggplotGrob(plot1)
     g2 <- ggplotGrob(plot2) 
     g <- rbind(g1, g2, size = "first")

     g$widths <- grid::unit.pmax(g1$widths, g2$widths)
     grid::grid.newpage()
     grid::grid.draw(g)
     graphics.off()
}

}
```


```{r univariate-plots-swath}

if(run.additional.figures == TRUE){

new.file = paste0(Fig_Loc,"Swath-Site-x-Year/")
dir.create(new.file)
# fish1a does not delete low vis data
swathx = swath0
# swathx = swath1[swath1$zone == 5,]
swathx$taxa = swathx$species

swath.log = aggregate( log(Count+1) ~ site + year +  taxa , data = swathx, FUN = mean )
colnames(swath.log)[ncol(swath.log)] <- 'mean'

swath.mean = aggregate( Count ~ site + year +  taxa , data = swathx, FUN = mean )
colnames(swath.mean)[ncol(swath.mean)] <- 'mean'

spp = as.character(levels(as.factor(swath.log$taxa)))

for(i in 1:length(spp)){
     graphics.off()
     
     jpeg(paste0(new.file,spp[i],"-site_by_year.jpg"))
     df1 = swath.log[swath.log$taxa==spp[i],]
     plot1 = species.plot.SxY(data.file = df1, Ylab = 'Log(x+1)')
     
     df2 = swath.mean[swath.mean$taxa==spp[i],]
     plot2 = species.plot.SxY(data.file = df2, Ylab = 'Arith.Mean')
     
     g1 <- ggplotGrob(plot1)
     g2 <- ggplotGrob(plot2) 
     g <- rbind(g1, g2, size = "first")

     g$widths <- grid::unit.pmax(g1$widths, g2$widths)
     grid::grid.newpage()
     grid::grid.draw(g)
     
     graphics.off()
}

}
```

## A subset of specific year x site comparisons.

Kelp plot includes only 5-m. 


```{r kelp-site-year, fig.width=4.5, fig.height=6}
swathx = swath0
# swathx = swath1[swath1$zone == 5,]
swathx$taxa = swathx$species

kelp.ylabel = "Stipes per transect"

swath5 = aggregate(Count ~ site + year +  taxa , data = swathx[swathx$zone==5,], FUN = mean )
colnames(swath5)[ncol(swath5)] <- "mean"

macro = swath5[swath5$taxa=="MACPYR",]
nereo = swath5[swath5$taxa=="NERLUE",]
ptero = swath5[swath5$taxa=="PTECAL",]

macro = species.plot.SxY(data.file = macro, Ylab = kelp.ylabel)
nereo = species.plot.SxY(data.file = nereo, Ylab = kelp.ylabel)
ptero = species.plot.SxY(data.file = ptero, Ylab = kelp.ylabel)
     

g1 <- ggplotGrob(macro)
g2 <- ggplotGrob(nereo)
g3 <- ggplotGrob(ptero) 
g <- rbind(g1, g2, g3, size = "first")

g$widths <- grid::unit.pmax(g1$widths, g2$widths, g3$widths)
grid::grid.newpage()
grid::grid.draw(g)
     

```

```{r urchinsp-site-year, fig.width=4.5, fig.height=6}

swath5 = aggregate( Count ~ site + year +  taxa , data = swathx[swathx$zone==5,], FUN = mean )
colnames(swath5)[ncol(swath5)] <- "mean"

urchin.ylab = "No. per transect"

purp = swath5[swath5$taxa=="STRPUR",]
red = swath5[swath5$taxa=="MESFRA",]
green = swath5[swath5$taxa=="STRDRO",]

purp = species.plot.SxY(data.file = purp, Ylab = urchin.ylab )
red = species.plot.SxY(data.file = red, Ylab = urchin.ylab )
green = species.plot.SxY(data.file = green, Ylab = urchin.ylab )
     
g1 <- ggplotGrob(purp)
g2 <- ggplotGrob(red)
g3 <- ggplotGrob(green) 
g <- rbind(g1, g2, g3, size = "first")

g$widths <- grid::unit.pmax(g1$widths, g2$widths, g3$widths)
grid::grid.newpage()
grid::grid.draw(g)
     

```

## Site x Year x Depth


```{r fish-site-year-depth}

if(run.additional.figures == TRUE){

new.file = paste0(Fig_Loc,"Fish-Site-x-Year-x-Depth/")
dir.create(new.file)

fish.log = aggregate(log(Count+1) ~ year + site + zone + species, data=fish1, FUN=mean)
colnames(fish.log)[ncol(fish.log)]<- 'mean'
fish.log$taxa = fish.log$species

fish.mean = aggregate(Count ~ year + site + zone + species, data=fish1, FUN=mean)
colnames(fish.mean)[ncol(fish.mean)]<- 'mean'
fish.mean$taxa = fish.mean$species

spp <- levels(as.factor(fish.log$taxa))
     
for(i in 1:length(spp)){
     
     graphics.off()
     
     jpeg(paste0(new.file,spp[i],"-site_by_year_by_depth.jpg"))
     
     df1 = fish.log[fish.log$taxa == spp[i], ]
     df2 = fish.mean[fish.mean$taxa == spp[i], ]
     
     plot1 = species.plot.SxYxD(df1 , Ylab = 'Log(x+1)')
     plot2 = species.plot.SxYxD(df2 , Ylab = 'Arth. mean')
     
     g1 <- ggplotGrob(plot1)
     g2 <- ggplotGrob(plot2) 
     g <- rbind(g1, g2, size = "first")

     g$widths <- grid::unit.pmax(g1$widths, g2$widths)
     grid::grid.newpage()
     grid::grid.draw(g)
     graphics.off()
     
}    

}
     
```     

```{r swath-site-year-depth}
if(run.additional.figures == TRUE){
     
     new.file = paste0(Fig_Loc,"Swath-Site-x-Year-x-Depth/")
dir.create(new.file)

swath.log = aggregate(log(Count+1) ~ year + site + zone + species, data=swath0, FUN=mean)
colnames(swath.log)[ncol(swath.log)]<- 'mean'
swath.log$taxa = swath.log$species

swath.mean = aggregate(Count ~ year + site + zone + species, data=swath0, FUN=mean)
colnames(swath.mean)[ncol(swath.mean)]<- 'mean'
swath.mean$taxa = swath.mean$species

spp <- levels(as.factor(swath.log$taxa))
     
for(i in 1:length(spp)){
     
     graphics.off()
     
     jpeg(paste0(new.file,spp[i],"-site_by_year_by_depth.jpg"))
     
     df1 = swath.log[swath.log$taxa == spp[i], ]
     df2 = swath.mean[swath.mean$taxa == spp[i], ]
     
     plot1 = species.plot.SxYxD(df1 , Ylab = 'Log(x+1)')
     plot2 = species.plot.SxYxD(df2 , Ylab = 'Arth. mean')
     
     g1 <- ggplotGrob(plot1)
     g2 <- ggplotGrob(plot2) 
     g <- rbind(g1, g2, size = "first")

     g$widths <- grid::unit.pmax(g1$widths, g2$widths)
     grid::grid.newpage()
     grid::grid.draw(g)
     graphics.off()
     
}    

}
```   


# Fish YOY and Kelp 


```{r fish-kelp}
###### fish ####
########fish1 includes all spp and five sites but no deletion of low ivs.

# drop low vis sites/transects
fish1a = fish1[fish1$vis_m >= min.vis, ]

# double check specific averaging process here 

fish_area = aggregate( Count ~ site + zone + year + area + taxa, data = fish1a, FUN = mean )
colnames(fish_area)[ncol(fish_area)] <- 'mean'
fish_area_wide = pivot_wider(fish_area , names_from = taxa , values_from = mean)
fishid = paste(fish_area_wide$site, 
               fish_area_wide$year,
               fish_area_wide$zone,
               fish_area_wide$area, sep="_")
# fish wide format, with "area"
fish_wide = data.frame(cbind(fishid, fish_area_wide))
colnames(fish_wide)[1] <- 'id'
### kelp #####

kelp_area = aggregate( Count ~ site + zone + year + area + taxa, data = swath0, FUN = mean )
colnames(kelp_area)[ncol(kelp_area)] <- 'mean'
kelp_area = kelp_area[kelp_area$taxa %in% c("MACPYR", "NERLUE", "PTECAL"),]
kelp_area_wide = pivot_wider(kelp_area , names_from = taxa , values_from = mean)
kelpid = paste(kelp_area_wide$site, 
               kelp_area_wide$year,
               kelp_area_wide$zone,
               kelp_area_wide$area, sep="_")
#kelp wide format, with "area"
kelp_wide = data.frame(cbind(kelpid, kelp_area_wide))
colnames(kelp_wide)[1] <- 'id'

fish_kelp0 = merge(fish_wide, kelp_wide, all = TRUE, by='id')
# remove some duplicates
cn = colnames(fish_kelp0)
x = match(c('site.y','zone.y', 'year.y', 'area.y'),cn)
 
# combined fish and kelp file ####
# combined at the 'area': site x year x depth x area
fish_kelp = fish_kelp0[,-x]

saveRDS(fish_kelp , paste0(Data_Loc,'Data_Fish_x_Kelp.rds') )

```
## Some preliminary plots

Both fish and kelp data in these plots are log(x+1) means for Year x Site x Depth x Area.

Kelp are either total kelp (NERLUE+ MACPYR+PTECAL), canopy kelp (NERLUE+ MACPYR), or understory kelp (PTECAL)

At present, I've only done a few plots of yellow tail & black and coppers. 

```{r fish-and-kelp, fig.height=8, fig.width = 6}

fish_kelp$canopy_kelp = fish_kelp$NERLUE + fish_kelp$MACPYR
fish_kelp$kelp = fish_kelp$NERLUE + fish_kelp$MACPYR + fish_kelp$PTECAL
fish_kelp$year.x = as.factor(fish_kelp$year.x)
fish_kelp <- fish_kelp[ !is.na(fish_kelp$year.x), ]


plotquick <- function(data.file , X , Y , Xlab =' kelp', leg.pos="none"){
              
              cn<-colnames(data.file)
              x = match(X,cn)
              y = match(Y,cn)
              colnames(data.file)[x] <- "X"
              colnames(data.file)[y] <- "Y"
              p1 = ggplot(data.file, aes(x=X, y=Y, color = year.x) ) +
                    geom_point() +
                    scale_color_manual(values = col) +
                    xlab(Xlab)+
                    ylab(Y)+
                    theme_bw()+
                    theme( legend.title = element_blank(), 
                           legend.position = leg.pos )
     
              return(p1)
}

ytb.kelp.plot       <- plotquick(data.file = fish_kelp, X = 'kelp', Y = 'YTBLyoy' , 
                                 Xlab = "Total kelps")
ytb.canopy.plot     <- plotquick(data.file = fish_kelp, X = 'canopy_kelp', Y = 'YTBLyoy',
                                 Xlab = 'Canopy kelps')
ytb.understory.plot <- plotquick(data.file = fish_kelp, X = 'PTECAL', Y = 'YTBLyoy',
                                 Xlab = 'Understory kelps')

cop.kelp.plot       <- plotquick(data.file = fish_kelp, X = 'kelp', Y = 'SECAyoy', 
                                 Xlab = 'Toal kelps', leg.pos= c(0.8, 0.66))
cop.canopy.plot     <- plotquick(data.file = fish_kelp, X = 'canopy_kelp', Y = 'SECAyoy',
                                 Xlab = 'Canopy kelps')
cop.understory.plot <- plotquick(data.file = fish_kelp, X = 'PTECAL', Y = 'SECAyoy',
                                 Xlab = 'Understory kelps')

grid.arrange(
     ytb.kelp.plot, 
     cop.kelp.plot,
     
     ytb.canopy.plot,     
     cop.canopy.plot,
     
     ytb.understory.plot, 
     cop.understory.plot, 
     
     nrow = 3, ncol=2
     )

```


# Kelp and Urchins

## Summarized across sites for all years

Pretty strong relationship when averaged across sites within years for total urchins and total kelp. Where there is kelp, there are urchins. 

```{r kelp-vs-urchins, fig.width=3.5, fig.align=3.5}

swath2$mean = as.numeric(as.character(swath2$mean))
uk = c("MACPYR", "NERLUE", "PTECAL" ,"STRPUR","MESFRA","STRDRO")

swath.yr = aggregate(mean ~ year + species , data=swath2[swath2$species %in% uk,], FUN = mean )

UK = pivot_wider(swath.yr, values_from = 'mean', names_from = 'species')

UK$kelp = UK$MACPYR + UK$NERLUE + UK$PTECAL
UK$urchins = UK$STRPUR + UK$MESFRA + UK$STRDRO
UK$year = as.factor(UK$year)

lm1 = lm(urchins ~ kelp, data = UK)
s1 = summary(lm1)

p1 = ggplot(UK, aes(x = kelp, y=urchins , color = year)) +
     geom_point(size = 2) +
     xlab( 'Kelp stypes per transect' ) + 
     ylab( 'Urchins per transect' ) +
     geom_smooth(method='lm' , se=TRUE , col = 'black') + 
     theme_bw()+
     scale_color_manual(values = c('black',col) ) +
     theme( legend.title = element_blank() )

p1

```
Note, vs the original MS there are fewer data here because it is summarized by sites. We cold increase to transect level.  


```{r urchins-kelp, fig.width=6, fig.height=4}

swath0 = readRDS( paste0( Data_Loc,'Swath_2015-2021.rds' ))

swath1 = aggregate( Count~ site  + year + zone + species + group , data=swath0, FUN = mean)
x = ncol(swath1)
colnames(swath1)[ncol(swath1)] <- 'mean'
# inverts <- read_csv(here('Data','invert_swath_zonelevel.csv'))
# kelp <- read_csv(here('Data','algae_swath_zonelevel_lump.csv'))

urchins = swath1 %>% filter(species %in% c('MESFRA', 'STRPUR', 'STRDRO')) %>%
                     select(year,site,species, zone,mean)
     
kelp    = swath1 %>% filter(species %in% c("MACPYR", "NERLUE", "PTECAL")) %>%
                     select(year,site,species, zone, mean)

kelp_urchins <- kelp %>% select(year,site, species ,zone, mean) %>% 
                bind_rows(urchins) %>%
                pivot_wider(names_from='species',values_from= "mean")

library(cowplot)
library(viridis)

kelp_urchins_long <- kelp_urchins %>%
     pivot_longer(MACPYR:PTECAL , names_to = 'kelp_spp', values_to = 'kelp_density') %>%
      # mutate(kelp_spp = str_sub(kelp_spp,6,-1)) %>%
      mutate(kelp_spp = factor(kelp_spp, levels=c('MACPYR','NERLUE','PTECAL'))) %>%
     pivot_longer(MESFRA:STRPUR , names_to = 'urchin_spp', values_to = 'urchin_density') %>%
      # mutate(urchin_spp = str_sub(urchin_spp,6,-1)) %>%
      mutate(urchin_spp = factor(urchin_spp, levels=c("STRPUR","MESFRA","STRDRO")))        


kelp_urchins_long$yr = substr(kelp_urchins_long$year,4,4)
     
kelp_urchins_long <- kelp_urchins_long %>%
     filter(year != 2015) %>%
     filter(zone == 5) %>%
     filter(site %in% c('Neah Bay','Tatoosh Island','Cape Alava','Cape Johnson','Destruction Island') ) %>%
      mutate(site = factor(site, levels=c('Neah Bay','Tatoosh Island','Cape Alava','Cape Johnson','Destruction Island')))

# head(kelp_urchins_long)
kelp_urchins_long$log_kelp = log(kelp_urchins_long$kelp_density+1)
par(ps = 10, cex=1)


pl <- kelp_urchins_long %>%
  ggplot(aes(urchin_density, kelp_density, col=site))+
  geom_point(size=2.5, pch=kelp_urchins_long$yr)+
  # geom_point(size=1)+
  theme_minimal()+
  # scale_color_manual(values=color5 , pch=kelp_urchins_long$yr)+
  scale_color_manual(values=col)+
  facet_grid(urchin_spp ~ kelp_spp)+
  theme_bw()+
  theme( legend.title = element_blank(),
         legend.text = element_text(size = 7),
         legend.key.size =  unit(0.25,"point"),
         legend.background = element_blank(),
         axis.text = element_text( size = 8 ),
         axis.text.x = element_text( size = 8 ),
         strip.background = element_blank(),
         strip.text = element_text(size = 8),
         strip.placement = "inside",
         panel.grid  = element_blank(),
         panel.spacing = unit(0.5, "lines"),
         )+
  labs(x="Urchin Density",y="Kelp Density",col="Site")

lemon::reposition_legend(pl, 'top right', panel='panel-3-3')

```
Just re-plotting on a with algae on a log scale. This was our original plotting approach.

```{r}

pl <- kelp_urchins_long %>%
  ggplot(aes(urchin_density,log_kelp, col=site))+
  geom_point(size=2.5, pch=kelp_urchins_long$yr)+
  # geom_point(size=1)+
  theme_minimal()+
  # scale_color_manual(values=color5 , pch=kelp_urchins_long$yr)+
  scale_color_manual(values=col)+
  facet_grid(urchin_spp ~ kelp_spp)+
  theme_bw()+
  theme( legend.title = element_blank(),
         legend.text = element_text(size = 7),
         legend.key.size =  unit(0.25,"point"),
         legend.background = element_blank(),
         axis.text = element_text( size = 8 ),
         axis.text.x = element_text( size = 8 ),
         strip.background = element_blank(),
         strip.text = element_text(size = 8),
         strip.placement = "inside",
         panel.grid  = element_blank(),
         panel.spacing = unit(0.5, "lines"),
         )+
  labs(x="Urchin Density",y=("Log (Kelp Density +1)"),col="Site")

lemon::reposition_legend(pl, 'top right', panel='panel-3-3')



```

Same figure but for Tatoosh Island only 

```{r kelp-urchins-tatoosh}

kelp_urchins_tatoosh <- kelp_urchins_long %>%
                         filter(site =="Tatoosh Island")


plot1 <- ggplot( kelp_urchins_tatoosh, aes(urchin_density, kelp_density ) ) +
         # filter(site == "Tatoosh Island") +
         geom_point( size = 2 , pch = kelp_urchins_tatoosh$yr ) + 
         labs(x="Urchin Density",y="Kelp Density",col="Site") + 
         facet_grid(urchin_spp ~ kelp_spp)+
         theme_bw() 

plot1
```








 









