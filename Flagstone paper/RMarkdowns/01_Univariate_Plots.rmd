---
title: "Univariate data manipulation and plots"
author: Nick Toimieri
date: sys.date()
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: true
    fig_caption: true
fontsize: 11pt

---


```{r SETUP, include=FALSE}
# A bunch of initial set up junk

rm(list = ls())

# pre-run some stuff ####
# source("01a_Univariate_workhorse.R")

##### knitr stuff and libraries ####
# tools in use 
library(knitr)
library(tidyverse)
library(stringr)
library(RColorBrewer)
library(ggpubr) 
# library(tidyr)
# library(dplyr)
library(tinytex) # for pdf output

# display.brewer.all(colorblindFriendly = TRUE)
#vlibrary(readxl)

# stats packages etc
# library(vegan)
# library(BiodiversityR)
# library(pracma)
# library(factoextra)
source("R-functions-ocnms.r")


# Paths for files
# setwd('..')
# HomeFile = getwd()
HomeFile = "C:/Users/nick.tolimieri/Documents/GitHub/OCNMS/Flagstone paper"

Fig_Loc = paste0(HomeFile,"/Plots/")
Data_Loc = paste0(HomeFile,"/Data/")
Results_Loc = paste0(HomeFile,"/Results/")
Other_Files = paste0(HomeFile,"/Other Files/")

# options
knitr::opts_chunk$set(
  fig.path = Fig_Loc,
  cache.path = 'cache/graphics-', 
  echo=FALSE,
  error=FALSE,
  include = TRUE,
  dev='png',
  dpi=300,
  warning=FALSE,
  #out.width = '100%',
  fig.align='center'
  
  )

# just to keep track of when I ran things.

Last_Run0 = Sys.time()
Last_Run = str_replace(Last_Run0, ":", ".")
Last_Run = str_replace(Last_Run, ":", ".")
capture.output(Last_Run, file = 'Last_Run.txt')

par(ps=10, cex=1)



```

# Triggers and Settings


```{r triggers-and-settings}

# provided in Univariate_workhorse, sourced above
settings = readRDS( paste0(Data_Loc,'settings.RDS') )

min.vis = 2

years = 2015:2021
pch = c(8 , 21, 22, 23, 24, 4, 25 )
col = RColorBrewer::brewer.pal(n = 12, name = "Paired")[c(2,4,6,10,12,7,8)]
year.pch = data.frame(cbind(years, pch,col))

sites = c("Neah Bay","Tatoosh Island","Cape Alava","Cape Johnson","Destruction Island")
col = RColorBrewer::brewer.pal(n = 12, name = "Paired")[c(2,4,6, 10,12)]
site.col = data.frame(cbind(sites,col))
colnames(site.col) <- c('site', 'col')

#### species depths #####

kelp.depth = 5
fish.depth = c(5,10)
invert.depth = 5
# set for labelling plots below
depth.labs = c('5-m','10-m')
names(depth.labs) = c(5,10)
### species codes here 

fish_codes = data.frame(read.csv( paste0(Data_Loc,"spp_codes_fish.csv") ))
swath_codes = data.frame(read.csv( paste0(Data_Loc,"spp_codes_swath.csv") ))
kelp_codes = data.frame(read.csv( paste0(Data_Loc,"spp_codes_kelp.csv") ))

### combine settings and save out for multivariate file  ####
# will overwrite settings file from Univariate_workhorse

settings = list(min.vis = min.vis,
                years = years,
                pch = pch,
                col=col,
                sites=sites,
                year.pch = year.pch,
                site.col = site.col,
                kelp.deph = kelp.depth,
                fish.depth = fish.depth,
                invert.depth = invert.depth,
                fish_codes = fish_codes,
                swath_codes = swath_codes)

saveRDS(settings, file = paste0(Data_Loc,'settings.RDS') )


```


```{r set-global-plotting-theme}
 
theme_nt   <-   theme(legend.title=element_blank(),
                      legend.background = element_blank(),
                      axis.title = element_text(size=8),
                      axis.text.x = element_text(size=8),
                      strip.background = element_blank(),
                      legend.text = element_text(size = 8),
                      legend.key.size = unit(0.5,'lines')
)

saveRDS(theme_nt, file = paste0(Data_Loc, 'theme_nt.rds') )

```

# Import fish and manipulate data a bit

```{r import-fish, include=FALSE}
# read in rds file with combined data
fish0 = readRDS( paste0(Data_Loc,'Fish_2015-2021.rds' ))

# add in yoy designator and fix some names

fish0 <- fish0 %>% 
  left_join(.,fish_codes %>% dplyr::select(code,group),by=c("species"="code")) %>%
  rename(taxa=group)

fish0 <- fish0 %>% mutate(taxa=case_when(is.na(size_class)==TRUE ~ as.character(taxa),
                                         size_class=="large" ~ as.character(taxa),
                                         size_class=="small" ~ paste0(taxa,"yoy"))) %>%
                  mutate(taxa= ifelse(taxa=="RYOYyoy","RYOY",taxa))

# combine YT and black or keep separate? # COMBINE!
fish0 %>% filter(taxa %in% c('SEFLyoy','SEMEyoy','SEBYTyoy')) %>% group_by(taxa) %>% 
        summarise(Tot=sum(Count))

fish0$taxa[ fish0$taxa %in% c('SEFLyoy','SEMEyoy')] <- 'SEBYTyoy'

# Aggregate the SEBYTyoy so that there are one, not three, entries for "SEBYTyoy"
fish_yt <- fish0 %>% filter(taxa=="SEBYTyoy") %>% 
              group_by(site, transect,observer,
                       size_class,year,area,zone,vis_m,taxa) %>%
              summarise(Count_all=sum(Count, na.rm = TRUE)) %>% rename(Count=Count_all) %>%
              mutate(species="SEBYT",common.name=NA)
                
fish0 <- fish0 %>% filter(!taxa == "SEBYTyoy") %>% full_join(.,fish_yt)

# subset visibility ####
# add fake vis for 2015
fish0$vis_m[ fish0$year == 2015 ] <- 3
# poor vis at destruction in year 1.
fish0$vis_m[ fish0$year == 2015 & fish0$site == "Destruction Island"] <- 1

# output for multivariate ####
fish1 = fish0 %>% filter(site %in%  sites)

# drop low vis sites/transects and set depth
fish1a = fish1[fish1$vis_m >= min.vis, ]

# select depth ####
fish1b = fish1a[fish1a$zone %in% fish.depth,]

# calculate total yoy by site, transect, observer, and year
fish1b %>% filter(size_class == "small") %>% distinct(taxa)
# all of the small taxa are rockfish YOY.

fish1c <- fish1b %>% filter(size_class == "small") %>% 
                      group_by(site,year,transect,observer,zone,area) %>% 
                      summarise(Count_all=sum(Count, na.rm = TRUE)) %>%
                      mutate(species="TOTyoy",taxa="TOTyoy") %>%
                      rename(Count=Count_all)
fish1d <- fish1b %>% full_join(.,fish1c) 

# for combining below

fish_transect <- fish1d
                    
# Ole made this to check the aggregating in fish 2.
fish3 <-  fish1d %>% group_by(site,year,zone,species, taxa) %>%
              summarise(Mean=mean(Count, na.rm = TRUE),
                        SD=sd(Count),
                        N=length(Count),
                        SE=SD/sqrt(N))

# Check to make sure all of the site-year-zone combinations have equivalent number of transects.
fish3 %>% group_by(site,year,zone) %>% distinct(N) %>% as.data.frame()


### calculate means and se for species ####

fish4 <-  fish1d %>% group_by(site,year,species,taxa) %>%
              summarise(Mean=mean(Count, na.rm = TRUE),
                        SD=sd(Count),
                        N=length(Count),
                        SE=SD/sqrt(N),SE_var=SE^2)
saveRDS(fish4, paste0(Data_Loc,'Summarized_Data_Fish_site_year_species.rds'))

fish5 <- fish4 %>% group_by(year, species, taxa) %>%
                    summarise(grand_sum=sum(Mean, na.rm = TRUE),
                        N=length(Mean),
                        grand_mean= grand_sum / N,
                        grand_sum_var =sum(SE_var, na.rm = TRUE), 
                        grand_SE = sqrt(grand_sum_var / N^2))
saveRDS(fish5, paste0(Data_Loc,'Summarized_Data_Fish_year_species.rds'))

#### calculate means se for taxa #######
# lump by taxa for some plotting analysis.
# greenlings lumped in current plots

fish_taxa_Year_site <-  fish_transect %>% group_by(site,year,taxa) %>%
  summarise(Mean=mean(Count, na.rm = TRUE),SD=sd(Count),N=length(Count),
            SE=SD/sqrt(N),SE_var=SE^2)
saveRDS(fish_taxa_Year_site, paste0(Data_Loc,'Summarized_Data_Fish_site_year_taxa.rds'))

fish_taxa_year <-fish_taxa_Year_site %>% group_by(year,taxa) %>%
  summarise(grand_sum=sum(Mean, na.rm = TRUE),
            N=length(Mean),
            grand_mean= grand_sum / N,
            grand_sum_var =sum(SE_var, na.rm = TRUE), 
            grand_SE = sqrt(grand_sum_var / N^2))
saveRDS(fish_taxa_year, paste0(Data_Loc,'Summarized_Data_Fish_year_taxa.rds'))

#### for multivariate stuff below







```

Minimum vis for fish analysis = `r min.vis`-m

Kelp depths = `r kelp.depth` -m
Fish depths = `r fish.depth` -m
Inv  depths = `r invert.depth` -m

Visibility data for 2015 are fake. DI was bad and set at 1.0 m; other sites set at 3.0 m

# FISH

## Rockfish YOY

```{r rockfish-yoy, fig.width=5, fig.height=3.5}

fish_taxa_year <- readRDS(paste0(Data_Loc,'Summarized_Data_Fish_year_taxa.rds'))

fish.col = c(RColorBrewer::brewer.pal(n = 12, name = "Paired"))

SP.yoy <- c("SEBYTyoy", "Black & Yellowtail",  'black',
            "SECAyoy", "Copper",               fish.col[12],
            #"SEMAyoy", "Quillback",            fish.col[10],
            "SEMYyoy", "Blue" ,                fish.col[2],
            #"SENEyoy", "China",                fish.col[10],
            "SEPIyoy", "Canary",               fish.col[6],
            "RYOY", "Unidentified",            'darkgrey') # ,
            #"TOTyoy", "Total",                 fish.col[10])

SP.yoy <- matrix(SP.yoy,ncol=3,byrow=T) %>% as.data.frame()
colnames(SP.yoy) <- c("taxa","name",'col')

SP.yoy$name <- as.character(SP.yoy$name)
SP.yoy$name <- factor(SP.yoy$name,levels=SP.yoy$name)

yoy.plot <- ggplot(fish_taxa_year %>% filter(taxa %in% SP.yoy$taxa) %>% left_join(.,SP.yoy)) +
    geom_point(aes(x=year,y=grand_mean,color=name)) + 
    geom_line(aes(x=year,y=grand_mean,color=name)) +
    geom_errorbar(aes(x=year,color=name,ymin=grand_mean-grand_SE,ymax=grand_mean+grand_SE),
                  width=0) +
    scale_y_continuous(trans="sqrt",breaks=c(0,1,5,10,20,40,60,80),limits=c(0,NA)) +
    scale_x_continuous(breaks=seq(2015,2021)) +
    #scale_color_viridis_d(option="plasma", end=0.75) + 
    scale_color_manual(values=SP.yoy$col)+
    ylab("No. per transect") +
    xlab("Year") +
    theme_bw() + theme_nt +
    theme(legend.position = c(0.7, 0.8) )

yoy.plot

```

## Fish

Fish depth = `r fish.depth`

```{r fish, fig.width=5, fig.height=3.5}

fish_taxa_year <- readRDS(paste0(Data_Loc,'Summarized_Data_Fish_year_taxa.rds'))

fish.col = c(RColorBrewer::brewer.pal(n = 12, name = "Paired"))

fish.taxa <- c("OPEL", "Lingcod",     fish.col[10],
               "HEXA", "Greenlings", fish.col[4],
               "SCMA" ,"Cabazon",     fish.col[8],
               "SECA", "Copper RF",   fish.col[12],
               "SENE", "Blue RF",     fish.col[2],
               "SEFL", "Yellowtail RF", fish.col[7],
               "SEME", 'Black RF',    'black')

fish.taxa <- matrix(fish.taxa,ncol=3,byrow=T) %>% as.data.frame()
colnames(fish.taxa) <- c("taxa","name","col")

fish.taxa$name <- as.character(fish.taxa$name)
fish.taxa$name <- factor(fish.taxa$name,levels=fish.taxa$name)


fish.plot <- ggplot(fish_taxa_year %>% filter(taxa %in% fish.taxa$taxa) %>% left_join(.,fish.taxa)) +
  geom_point(aes(x=year,y=grand_mean,color=name)) + 
  geom_line(aes(x=year,y=grand_mean,color=name)) +
  geom_errorbar(aes(x=year,color=name,ymin=grand_mean-grand_SE,ymax=grand_mean+grand_SE),
                width=0) +
  scale_y_continuous(trans="sqrt",breaks=c(0,1,5,10),limits=c(0,10)) +
  scale_x_continuous(breaks=seq(2015,2021)) +
  #scale_color_viridis_d(option="plasma", end=0.75) + 
  scale_color_manual(values=fish.taxa$col)+
  ylab("No. per transect") +
  xlab("") +
  theme_bw() + theme_nt + 
  theme(legend.position = c(0.2, 0.8) )
        
fish.plot
```
## Fish and YOY plot 

Note: I have yellowtail here, but they are not in the multivariate stuff since we reall only saw them once.

```{r fish-yoy, fig.width=3.5, fig.height=6}

ggarrange(
  fish.plot,yoy.plot,
  labels = c('a) Fish','b) YOY'), 
  # labels = 'auto',
  font.label = list(face='plain', size = 10),
  hjust = -1.25,
  vjust = 2,
  nrow = 2, ncol=1,
  align = 'v'
)

```

## Fish and YOY facet by site x year


```{r supplement-fish-site-year, fig.width=5, fig.height=6}

fish_ys = readRDS( paste0(Data_Loc,'Summarized_Data_Fish_site_year_taxa.rds') ) %>% filter(taxa %in% fish.taxa[,1])
fish_ys$site = factor(fish_ys$site , levels = c("Neah Bay","Tatoosh Island","Cape Alava","Cape Johnson","Destruction Island"))

fish_ys <- fish_ys %>% left_join(.,fish.taxa)


ggplot(fish_ys , aes(x = year, y = Mean, color = site)) +
          geom_point() + 
          geom_line() + 
          geom_errorbar(aes(x=year,color=site,ymin=Mean-SE,ymax=Mean+SE),width=0) +
          scale_x_continuous(breaks=seq(2015,2021)) +
          scale_color_manual(values=site.col$col)+
          xlab("")+
          ylab(" Number per 30x2 m transect")+
          # facet_grid(rows = 'taxa', scales="free_y") +
          facet_wrap( ~ name, scales="free",nrow=4) +
          theme_bw() + theme_nt +
          theme(legend.position = c(0.7, 0.1))


```


```{r supplement-yoy-site-year, fig.width=5, fig.height=6}

yoy_ys = readRDS( paste0(Data_Loc,'Summarized_Data_Fish_site_year_taxa.rds') ) %>% 
         filter(taxa %in% SP.yoy[,1]) %>% 
          left_join(.,SP.yoy)

yoy_ys$site = factor(yoy_ys$site , levels = c("Neah Bay","Tatoosh Island","Cape Alava","Cape Johnson","Destruction Island"))


ggplot(yoy_ys , aes(x = year, y = Mean, color = site)) +
          geom_point() + 
          geom_line() + 
          geom_errorbar(aes(x=year,color=site,ymin=Mean-SE,ymax=Mean+SE),width=0) +
          scale_x_continuous(breaks=seq(2015,2021)) +
          scale_color_manual(values=site.col$col)+
          xlab("")+
          ylab(" Number per 30x2 m transect")+
          # facet_grid(rows = 'taxa', scales="free_y") +
          facet_wrap( ~ name, scales="free",nrow=3) +
          theme_bw() + theme_nt + 
          theme(  legend.position = c(0.85, 0.2) )
                  
            




```




# ALGAE

Kelp depth = `r kelp.depth`

```{r swath-data-import}

# read in rds file with combined data
swath0 <- readRDS( paste0(Data_Loc,'Swath_2015-2021.rds' ))
# spp_swath <- read.csv( paste0(Data_Loc,"spp_codes_swath.csv"))
# separate into algae and invertebrate data frames.

# swath1 <- left_join(swath0,spp_swath)
# just bring in higher level taxa designation
# swath0$taxa = swath_codes$taxa[ match(swath0$species, swath_codes$CLASSCODE) ]

swath1 <- swath0 %>% filter(site %in% sites)

swath1$site <- factor(swath1$site,levels=sites)

dat.algae   <- swath1 %>% filter(group=="Algae")
# functional groupings for algae
# nick made up the kelp_codes file. Ole should check FGs.
dat.algae$fun_gr = kelp_codes$functinal_group[ match(dat.algae$species, kelp_codes$species) ]

dat.invert  <- swath1 %>% filter(group=="Invert")
# higher taxa groupings for inverts; for grouping later
dat.invert$taxa = swath_codes$taxa[ match(dat.invert$species, swath_codes$CLASSCODE) ]

```


```{r more-kelp}
# removed 'observer' because it leads to multiple transects per transect...fucks up transition to wide
algae1 <- dat.algae %>% group_by(year,site,transect,species,zone,area,fun_gr) %>%
            summarise(total.count=sum(Count, na.rm = TRUE),
                      total.area=sum(Transect.area, na.rm = TRUE)) %>% 
            mutate(density = total.count / total.area )
kelp_transect <- algae1
saveRDS(algae1, file = paste0(Data_Loc,"Summarized_Data_Kelp_year_site_area_zone_spp.rds"))

# Aggregate up to the area level (within year site, zone) -- treat transects as replicates
algae2 <- algae1 %>% 
  group_by(year,site,species,zone,area,fun_gr) %>%
  summarise(mean.density=mean(density, na.rm = TRUE), 
            SD = sd(density), 
            N =length(year),
            SE= SD/sqrt(N) ) 
saveRDS(algae2, file = paste0(Data_Loc,"Summarized_Data_Kelp_year_site_zone_spp.rds"))
# kelp_area = algae2

# Aggregate up to the site level (within year, zone) -- treat transects as replicates
algae3 <- algae1 %>% 
  group_by(year,site,species,zone,fun_gr) %>%
  summarise(mean.density=mean(density, na.rm = TRUE), 
            SD = sd(density), 
            N =length(year),
            SE= SD/sqrt(N) ) 
saveRDS(algae3, file = paste0(Data_Loc,"Summarized_Data_Kelp_year_zone_spp.rds"))

#Trim to canopy species
 canopy <- algae3 %>% filter(fun_gr=="canopy",!species=="EGRMEN")
 canopy$site <- factor(canopy$site,levels=sites)
 
 sm = 0.5
 bg = 1
 SIZE = cbind(site=sites,size=c(sm,sm,sm,bg,sm)) %>% as.data.frame()
 
 canopy <- left_join(canopy,SIZE)
 canopy$size <- as.numeric(as.character(canopy$size))
 canopy$zone <- factor(canopy$zone)
  

```


## Canopy kelp 

Ole needs to check the definitions of canopy kelp here.  I took this from his code, which wasn't finished.

```{r canopy-kelp-site-year, fig.width=6.5, fig.height=4}

canopy$site = factor(canopy$site, levels = sites)

# Basic time-series by site and zone
 kelp1 = ggplot(canopy ) +
    geom_point(aes(x=year,y=mean.density,color=site)) +
    geom_line(aes(x=year,y=mean.density,color=site)) +
    geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
    facet_grid(species ~ zone,scales="free_y", labeller = labeller(zone=depth.labs)) +
    scale_x_continuous(breaks=seq(2015,2021)) +
    xlab("Year")+
    scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
    # scale_color_viridis_d(option="plasma",end=0.75)+
    scale_color_manual(values = site.col$col)+
    theme_bw()+ theme_nt 

kelp1+ rotate_x_text(angle = 45)
```

## Caonopy kelp 5 m only

```{r canopy-kelp-site-zone, fig.width=5, fig.height=5}
 # Basic time-series by site and zone
 kelp2 = ggplot(canopy %>% filter(zone==5)) +
   geom_point(aes(x=year,y=mean.density,color=site)) +
   geom_line(aes(x=year,y=mean.density,color=site)) +
   geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
   facet_grid(rows="species",scales="free_y") +
   scale_x_continuous(breaks=seq(2015,2021)) +
   scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
   # scale_color_viridis_d(option="plasma",end=0.75)+
   scale_color_manual(values = site.col$col)+
   theme_bw()+ theme_nt
kelp2
```

## Nereocystis at Tatoosh

```{r canopy-kelp-tatoosh , fig.width=5, fig.height=3.5}
 # Basic time-series by site and zone TATOOSH FOCUS
kelp3 =  ggplot(canopy %>% filter(site=="Tatoosh Island",species=="NERLUE")) +
   geom_point(aes(x=year,y=mean.density,color=zone),alpha=0.5) +
   geom_line(aes(x=year,y=mean.density,color=zone),alpha=0.5) +
   geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=zone),width=0) +
   #facet_grid(rows="species",scales="free_y") +
   scale_x_continuous(breaks=seq(2015,2021)) +
   scale_y_continuous(expression("Stipe density (stipe m"^-2*")"),limits=c(0,NA)) +
   scale_color_viridis_d("Depth (m)",option="plasma",end=0.75)+
   ggtitle("Tatoosh Island") +
   theme_bw() + theme_nt
kelp3

```

## Nero and Macro 

```{r nero-macro , fig.height=3.5, fig.width=5}
kelp_year_site_area <- 
  readRDS(  paste0(Data_Loc,"Summarized_Data_Kelp_year_site_area_zone_spp.rds") )

kelp_year_site_area$site = factor(kelp_year_site_area$site, levels = sites)

mac_ner <- kelp_year_site_area %>% filter(species %in% c("NERLUE","MACPYR"))
 
mac_ner1 <- mac_ner %>% group_by(year,site,zone,area) %>%
              summarise(mean.density=mean(density, na.rm = TRUE), 
                SD = sd(density), 
                N =length(year),
                SE= SD/sqrt(N) ) 
mac_ner_zone <- mac_ner %>% group_by(year,site,zone) %>%
    summarise(mean.density=mean(density, na.rm = TRUE), 
             SD = sd(density), 
             N =length(year),
             SE= SD/sqrt(N) ) 
 
  # Basic time-series by site and zone
  all_canopy_zone <- ggplot(mac_ner_zone ) +
    geom_point(aes(x=year,y=mean.density,color=site)) +
    geom_line(aes(x=year,y=mean.density,color=site)) +
    geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
    facet_grid(rows="zone",scales="free_y", labeller = labeller(zone = depth.labs)) +
    scale_x_continuous(breaks=seq(2015,2021)) +
    scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
    # scale_color_viridis_d(option="plasma",end=0.75)+
    scale_color_manual(values = site.col$col)+
    theme_bw()+ theme_nt
 all_canopy_zone
```

## Big three: Nero, Macro, Ptero

Plot the big 3 species: Macro, Nero, Ptero

```{r big3, fig.width=6, fig.height=4}
 # big three species
 big3spp = c('MACPYR', 'NERLUE', 'PTECAL')
 big3 <- algae3 %>% filter(species %in% big3spp)
 big3$site <- factor(big3$site,levels=sites)
 
 kelp.labs = c('Macrocystis','Nereocystis','Pterygophora')
 names(kelp.labs) <- big3spp
 
 
 big3$site = factor(big3$site, levels = sites)
 # Basic time-series by site and zone
 kelp1 = 
   # ggplot(big3 %>%  filter(zone==5)) +
   ggplot(big3) +
    geom_point(aes(x=year,y=mean.density,color=site)) +
    geom_line(aes(x=year,y=mean.density,color=site)) +
    geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
    facet_grid(species ~ zone,scales="free_y", labeller = labeller(zone=depth.labs , species=kelp.labs)) +
    scale_x_continuous(breaks=seq(2015,2021)) +
    xlab("Year")+
    scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
    # scale_color_viridis_d(option="plasma",end=0.75)+
    scale_color_manual(values = site.col$col)+
    theme_bw()+ theme_nt + 
    theme(strip.text.y = element_text(face='italic'))

kelp1 + rotate_x_text(angle = 45)

```

### Big three 5 m only  

```{r big3-5m, fig.width=4.5, fig.height=4}
 # big three species
 big3spp = c('MACPYR', 'NERLUE', 'PTECAL')
 big3 <- algae3 %>% filter(species %in% big3spp)
 big3$site <- factor(big3$site,levels=sites)
 
 big3$site = factor(big3$site, levels = sites)
 # Basic time-series by site and zone
 kelp1 = 
   # ggplot(big3 %>%  filter(zone==5)) +
   ggplot(big3 %>% filter(zone==5)) +
    geom_point(aes(x=year,y=mean.density,color=site)) +
    geom_line(aes(x=year,y=mean.density,color=site)) +
    geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
    facet_grid(rows='species' ,scales="free_y", labeller = labeller(species=kelp.labs)) +
    scale_x_continuous(breaks=seq(2015,2021)) +
    xlab("Year")+
    scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
    # scale_color_viridis_d(option="plasma",end=0.75)+
    scale_color_manual(values = site.col$col)+
    theme_bw()+ theme_nt

kelp1 + rotate_x_text(angle = 45)

```

### Big three - Coastwide

```{r kelp-coastwide, fig.height=3.5, fig.width=5}

# mean coastwide across depths

dfx <- big3 %>% group_by(year, species) %>%
                summarise(Mean = mean(mean.density, na.rm = TRUE), 
                          SD = sd(mean.density),
                          N = length(year),
                          SE = SD/sqrt(N)
                )

kelp_coast <- ggplot( dfx , aes(x=year, y=Mean, color=species)) +
                geom_point() +
                geom_line() +
                geom_errorbar(aes(x=year,
                                       ymin=Mean-SE,
                                       ymax=Mean+SE,color=species),width=0) +
                scale_color_manual(values = site.col$col)+
                scale_x_continuous(breaks=seq(2015,2021)) +
                xlab("Year")+
                scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
                theme_bw()+ theme_nt +
                ggtitle('Kelps 5 and 10 m')

kelp_coast
```

### Coastwide 5m only  


```{r kelp-coastwide-5m, fig.height=3, fig.width=5}

# mean coastwide across depths


dfx5 <- big3 %>% group_by(year, species) %>% filter(zone == 5) %>%
                summarise(Mean = mean(mean.density, na.rm = TRUE), 
                          SD = sd(mean.density),
                          N = length(year),
                          SE = SD/sqrt(N)
                ) 
dfx5$species[dfx5$species=='MACPYR'] <- 'Macrocystis'  
dfx5$species[dfx5$species=='NERLUE'] <- 'Nereocystis'  
dfx5$species[dfx5$species=='PTECAL'] <- 'Pterygophora'  

kelp_coast5 <- ggplot( dfx5 , aes(x=year, y=Mean, color=species)) +
                geom_point() +
                geom_line() +
                geom_errorbar(aes(x=year,
                                       ymin=Mean-SE,
                                       ymax=Mean+SE,color=species),width=0) +
                scale_color_manual(values = site.col$col)+
                scale_x_continuous(breaks=seq(2015,2021)) +
                xlab("")+
                scale_y_continuous(expression("Stipe density (stipe m"^-2*")"), limits = c(0,3)) +
               
                theme_bw()+ theme_nt + 
                theme( legend.text = element_text(face = 'italic'),
                       legend.position = c(0.2, 0.8),
                       legend.key.size = unit(0.5,'lines'))
                

kelp_coast5
```

# INVERTEBRATES


```{r invert-data}
# data imported above with kelps

# set proper site order
dat.invert$site = factor(dat.invert$site, levels = sites)

# add a column to sum urchins and seastars
u = grep('urchin', dat.invert$taxa)
dat.invert$grp2 = 'no'
dat.invert$grp2[u] <- 'URCHIN'

s = grep('star', dat.invert$taxa)
dat.invert$grp2[s] = 'STAR'

dat.invert$grp2[dat.invert$taxa %in% c('Pisaster','Pycnopodia')] <- 'STAR'


# Aggregate up to the transect level (within year, site, area, zone)
invert_transect <- dat.invert %>% group_by(year,site,transect,observer,species,zone,area,taxa,grp2) %>%
    summarise(total.count=sum(Count, na.rm = TRUE),total.area=sum(Transect.area, na.rm = TRUE)) %>% 
    mutate(density = total.count / total.area )
saveRDS(invert_transect, file=paste0(Data_Loc , "Sumized_Data_Inverts_year_site_zone_area_transect_taxa.rds") )

# Aggregate up to the area level (within year, site, zone) -- treat transects as replicates
invert_area <- invert_transect %>% 
    group_by(year,site,species,zone,area,taxa) %>%
    summarise(mean.density=mean(density), 
              SD = sd(density), 
              N =length(year),
              SE= SD/sqrt(N) ) 
```

## Summed Urchins 

Ole will want to clean up the figure

```{r total-urchins, fig.width=5, fig.height=3.5}
  # Zoom in on urchins
urchin1 <- invert_transect %>% filter(grp2=="URCHIN") %>%
    group_by(year,site,transect,observer,zone,area,grp2) %>%
    summarise(tot.density = sum(density, na.rm = TRUE)) %>% 
    group_by(year,site,zone,area,grp2) %>%
    summarise(mean.density=mean(tot.density, na.rm = TRUE), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) ) 
 
urchin_zone <- invert_transect %>% filter(grp2=="URCHIN") %>%
    group_by(year,site,transect,observer,area,zone,grp2) %>%
    summarise(tot.density = sum(density, na.rm = TRUE)) %>% 
    group_by(year,site,zone,grp2) %>%
    summarise(mean.density=mean(tot.density, na.rm = TRUE), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) ) 
  
ggplot() +
     # geom_point(data= urchin1,aes(x=year,y=mean.density,color=site)) +
      geom_point(data=urchin_zone,aes(x=year,y=mean.density,color=site)) +
      geom_line(data= urchin_zone,
                 aes(x=year,y=mean.density,color=site)) +
      geom_errorbar(data=urchin_zone,
                    aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
      facet_grid(rows="zone", labeller = labeller(zone=depth.labs )) +
      scale_x_continuous(breaks=seq(2015,2021)) +
      scale_y_continuous(expression("Urchin density (m"^-2*")")) +
      # scale_color_viridis_d(option="plasma",end=0.75)+
      scale_color_manual(values = site.col$col)+
      theme_bw()+ theme_nt
   

```

## Urchins by species

Probably worth dropping into the supplement to show that it was mostly purple urchins. Partly interesting because there is no purple urchin fishery, but there is a red one. I think.

```{r urchins-combined, fig.width=6.5, fig.height=4}

urchins_all <- invert_transect %>% filter(grp2=="URCHIN") %>%
    group_by(year,site,transect,observer,zone,area,taxa) %>%
    summarise(tot.density = sum(density, na.rm = TRUE)) %>% 
    group_by(year,site,zone,taxa) %>%
    summarise(mean.density=mean(tot.density, na.rm = TRUE), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) )
# fix some names

urchins_all$taxa[urchins_all$taxa=='purple urchin'] <- 'Purple urchin'
urchins_all$taxa[urchins_all$taxa=='red urchin'] <- 'Red urchin'
urchins_all$taxa[urchins_all$taxa=='green urchin'] <- 'Green urchin'

# set factor level order
urchins_all$taxa = factor(urchins_all$taxa, levels = c('Purple urchin','Red urchin','Green urchin'))
# plot 

urchin5  <- filter(urchins_all , zone == 5)
urchin10 <- filter(urchins_all , zone == 10)
depth.labs = c('5-m','10-m')
names(depth.labs) = c(5,10)

urchin_plot_all <- ggplot(data=urchins_all,aes(x=year, y= mean.density, col = site)) +
                    #geom_point(data=urchin5,aes(x=year, y= mean.density, col = site) ) +
                    #geom_line(data=urchin5, aes(x=year, y= mean.density, col = site) ) +
                    geom_point() +
                    geom_line()+
                    geom_errorbar(data=urchins_all,
                                  aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
                    #facet_grid(rows="taxa") + 
                    facet_grid( taxa ~ zone , 
                                labeller = labeller(zone = depth.labs) ) +#,scales="free_y") +
                    scale_color_manual(values = site.col$col) +
                    scale_x_continuous("Year", breaks=seq(2015,2021)) +
                    scale_y_continuous(expression("Urchin density (m"^-2*")")) +
                    theme_bw()+ theme_nt
urchin_plot_all + rotate_x_text(angle = 45)

```


```{r urchin-spp-year}

urchin_year <- urchins_all %>% group_by(taxa, year) %>%
               summarize(Mean = mean(mean.density, na.rm = TRUE), 
                         SD = sd(mean.density), 
                         N = length(site),
                         SE = sqrt(SD)/N)



urchin.plot <- ggplot(urchin_year, aes(x = year, y=Mean, color=taxa)) +
                geom_point() + 
                geom_line() + 
                geom_errorbar(data=urchin_year, 
                              aes(x=year, ymin=Mean-SE ,ymax=Mean+SE ,  color=taxa),width=0) +
                scale_color_manual(values = site.col$col[c(4,3,2)]) +
                scale_x_continuous("", breaks=seq(2015,2021)) +
                scale_y_continuous(expression("Urchin density (m"^-2*")"), limits=c(0,3)) +
                theme_bw()+ theme_nt +
                theme(legend.position = c(0.2, 0.8),
                      legend.key.size = unit(0.75,'lines'))

urchin.plot

```
 

## Seastars

```{r total-seastars}


star_zone <- invert_transect %>% filter(grp2=="STAR") %>%
    group_by(year,site,transect,observer,area,zone,grp2) %>%
    summarise(tot.density = sum(density, na.rm = TRUE)) %>% 
    group_by(year,site,zone,grp2) %>%
    summarise(mean.density=mean(tot.density, na.rm = TRUE), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) ) 

ggplot() +
      geom_point(data= star_zone,aes(x=year,y=mean.density,color=site)) +
      geom_line(data= star_zone,
                 aes(x=year,y=mean.density,color=site)) +
      geom_errorbar(data=star_zone,aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
      facet_grid(rows="zone", labeller = labeller(zone = depth.labs)) + #,scales="free_y") +
      scale_x_continuous(breaks=seq(2015,2021)) +
      scale_y_continuous(expression("Star density (m"^-2*")")) +
      # scale_color_viridis_d(option="plasma",end=0.75)+
      scale_color_manual(values = site.col$col)+
      theme_bw()+ theme_nt
       




```
```{r total-seastars-year-5-10m}


star_zone <- invert_transect %>% filter(grp2=="STAR") %>% filter(taxa != 'sea_star_YOY') %>%
    group_by(year,site,transect,area,zone,taxa) %>%
    summarise(tot.density = sum(density, na.rm = TRUE)) %>% 
    group_by(year,site,zone,taxa) %>%
    summarise(mean.density=mean(tot.density, na.rm = TRUE)) %>%
    group_by(year, taxa) %>%
    summarise(Mean=mean(mean.density, na.rm = TRUE), 
              SD = sd(mean.density), 
              N =length(year),
              SE= SD/sqrt(N) )


star.col = RColorBrewer::brewer.pal(n = 12, name = "Paired")[c(2,4,6,10,12,7,8)]
stars_year <- ggplot() +
      geom_point(data = star_zone, aes(x=year,y=Mean,color=taxa)) +
      geom_line( data = star_zone, aes(x=year,y=Mean,color=taxa)) +
      geom_errorbar(data=star_zone,aes(x=year,ymin=Mean-SE,ymax=Mean+SE,color=taxa),width=0) +
      scale_x_continuous(breaks=seq(2015,2021)) +
      xlab("") +
      scale_y_continuous(expression("Star density (m"^-2*")")) +
      # scale_color_viridis_d(option="plasma",end=0.75)+
      scale_color_manual(values = star.col)+
      theme_bw()+ theme_nt + 
      theme(legend.position = c(0.7, 0.7), legend.key.size = unit(0.75,'lines')) +
      guides(color=guide_legend(ncol=2))


stars_year

```

Ugly..no aliby..


```{r seastars-all}

stars_all <- invert_transect %>% filter(.,grp2 == 'STAR') %>%
    group_by(year,site,transect,observer,zone,area,taxa) %>%
    summarise(tot.density = sum(density, na.rm = TRUE)) %>% 
    group_by(year,site,zone,taxa) %>%
    summarise(mean.density=mean(tot.density, na.rm = TRUE), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) )

stars_plot_all <- ggplot(data=stars_all,aes(x=year, y= mean.density, col = site)) +
                    #geom_point(data=urchin5,aes(x=year, y= mean.density, col = site) ) +
                    #geom_line(data=urchin5, aes(x=year, y= mean.density, col = site) ) +
                    geom_point() +
                    geom_line()+
                    geom_errorbar(data=urchin5,
                                  aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
                    #facet_grid(rows="taxa") + 
                    facet_grid( taxa ~ zone, scales="free_y") +
                    scale_color_manual(values = site.col$col) +
                    scale_x_continuous("Year", breaks=seq(2015,2021)) +
                    scale_y_continuous(expression("Urchin density (m"^-2*")")) +
                    theme_bw()+ theme_nt
                   
  
stars_plot_all

```

# COMBINED KELP - URCHIN - SEASTAR PLOTS   

## By site and zone  


```{r kelp-urchin-stars-site-zone, eval=FALSE}

mac_ner_zone$grp2 = 'CANOPY KELP'

ystrip = c('Canopy kelps','Urchins','Seastars')
names(ystrip) =  c('CANOPY KELP','URCHIN','STAR')

# join to facet later
kus <-  mac_ner_zone %>%
               full_join(., y=star_zone, by=c('site','year','zone') ) %>% 
               full_join(., y=urchin_zone,  by=c('site','year','zone')) %>%
               mutate(density = mean.density)
# set plot order
kus$site <- factor(kus$site, levels = sites)
kus$grp2 = factor(kus$grp2, levels = c('CANOPY KELP','URCHIN','STAR'))
kus_plot <- ggplot(kus, mapping = aes(x = year, y=density, color = site)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(kus,mapping=aes(x=year,ymin=density-SE,ymax=density+SE,color=site),width=0) +
  facet_grid(grp2 ~ zone, scales="free_y", labeller = labeller(zone=depth.labs, grp2 = ystrip ) ) +
  scale_color_manual(values = site.col$col) +
  scale_x_continuous("Year", breaks=seq(2015,2021)) +
  scale_y_continuous(expression("Density (m"^-2*")")) +
  theme_bw()+ theme_nt
                 
                   

kus_plot+ rotate_x_text(angle = 45)

```
 
 
## By year and zone summarized across sites  


```{r kelp-urchin-stars-zone, fig.width=5, fig.height=4, eval=FALSE}

kus_year_zone   <- kus %>% group_by(year,zone,grp2) %>%
                      summarise(density=mean(density, na.rm = TRUE),
                         SD = sd(density), N =length(year),SE= SD/sqrt(N) )

# not sure why, but won't calculate SD
# frustrating a fuck.

SD = aggregate( density ~ year + grp2 +zone , data = kus, FUN=sd)
SD$density = SD$density/sqrt(5)
SE = SD %>% rename(SE = density)

kus_year_zone <- kus_year_zone %>%
                left_join(.,SE, by=c('year','grp2','zone')) %>%
                rename(SE = SE.y)


kus_year_zone_plot <- ggplot(kus_year_zone, mapping = aes(x = year, y=density)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(kus_year_zone,mapping=aes(x=year,ymin=density-SE,ymax=density+SE),width=0) +
  facet_grid(grp2 ~ zone, scales="free_y",labeller = labeller(zone = depth.labs, grp2=ystrip)) +
  # scale_color_manual(values = site.col$col) +
  scale_x_continuous("Year", breaks=seq(2015,2021)) +
  scale_y_continuous(expression("Density (m"^-2*")")) +
  theme_bw()+
  theme(legend.title = element_blank(), strip.background = element_blank())                  
                   

kus_year_zone_plot+ rotate_x_text(angle = 45)

```

## Summarized across sites; 5 m and 10 m depths combined  


```{r kelp-urchin-stars-zone-5-10, fig.width=3.5, fig.height=4, eval=FALSE}

kus_year   <- kus %>% group_by(year,grp2) %>%
                      summarise( density=mean(density, na.rm = TRUE),
                         SD = sd(density), N =length(site), SE= SD/sqrt(N) )
# not sure why, but won't calculate SD
# frustrating a fuck.

SD = aggregate( density ~ year + grp2 , data = kus, FUN=sd)
SD$density = SD$density/sqrt(5)
SE = SD %>% rename(SE = density)

kus_year <- kus_year %>%
                left_join(.,SE, by=c('year','grp2')) %>%
                rename(SE = SE.y)

kus_year_plot <- ggplot(kus_year, mapping = aes(x = year, y=density)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(kus_year,mapping=aes(x=year,ymin=density-SE,ymax=density+SE),width=0) +
  facet_grid(rows = 'grp2' , scales="free_y", labeller = labeller(grp2 = ystrip) ) +
  # scale_color_manual(values = site.col$col) +
  scale_x_continuous("Year", breaks=seq(2015,2021)) +
  scale_y_continuous(expression("Density (m"^-2*")")) +
  theme_bw()+
  theme(legend.title = element_blank(), strip.background = element_blank())                  
                   

kus_year_plot

```
   
## Summarized across sites; 5-m depth zone only  

```{r kelp-urchin-stars-5, fig.width=3.5, fig.height=4, eval=FALSE}

kus_year5m   <- kus %>% filter(., zone==5) %>% # 5-m depth only
                      group_by(year,grp2) %>%
                      summarise(density=mean(density, na.rm = TRUE),
                         SD = sd(density), 
                         N  = length(site),
                         SE = SD/sqrt(N) )
# not sure why, but won't calculate SD
# frustrating a fuck.

SD = aggregate( density ~ year + grp2 , data = kus, FUN=sd)
SD$density = SD$density/sqrt(5)
SE = SD %>% rename(SE = density)

kus_year5m <- kus_year5m %>%
                left_join(.,SE, by=c('year'='year','grp2'='grp2')) %>%
                rename(SE = SE.y)



kus_year_plot5 <- ggplot(kus_year5m, mapping = aes(x = year, y=density)) + 
  geom_point() +
  geom_line() +
  geom_errorbar(kus_year5m,mapping=aes(x=year,ymin=density-SE,ymax=density+SE),width=0) +
  facet_grid(rows = 'grp2' , scales="free_y", labeller=labeller(grp2=ystrip)) +
  # scale_color_manual(values = site.col$col) +
  scale_x_continuous("Year", breaks=seq(2015,2021)) +
  scale_y_continuous(expression("Density (m"^-2*")")) +
  theme_bw()+
  theme(legend.title = element_blank(), strip.background = element_blank())                  
                   

kus_year_plot5

```
  
# Output data for multivariate statistics  

## Combine kelp, fish, and inverts for capscale analysis  

Not yet transformed to wide format in order to retain SD & SE info upon saving out. 
Transform in the Multiariate analysis rmd.

Output data files to use for multivariate ordinations. 

Use these files and not raw files. Kelp and invert data have been converted to density to account for different transect lengths etc.

```{r spit-out-kelp-fish-4-multivariate, include = FALSE}

# comnbine fish spp into higher level taxa at the transect level
# fish_transect calculated above
fish_transect_taxa <-  fish_transect %>% group_by(site,year,area, zone, transect, taxa) %>%
                       summarise(Count = sum(Count))

# comnbine inverts spp into higher level taxa at the transect level
# dat.invert is raw file subsetted to just inverts
invert_transect_taxa <- dat.invert %>% group_by(year,site,transect,zone,area,taxa) %>%
    summarise(total.count=sum(Count, na.rm = TRUE),total.area=sum(Transect.area)) %>% 
    mutate(density = total.count / total.area )

# fake areas for 2015
fish_transect_taxa$area[fish_transect_taxa$year == 2015] <- "N"
kelp_transect$area[kelp_transect$year == 2015] <- "N"
invert_transect_taxa$area[invert_transect_taxa$year == 2015] <- "N"


#### output for CAPdiscrim analyses or nMDS ####
#### all transect level but with fish and inverts summed by higher taxa

fish_wide_transect = pivot_wider(fish_transect_taxa[,c('year','site','transect','area','zone','Count','taxa')] ,
                        values_from = Count, names_from = taxa, values_fill = 0 )
saveRDS(fish_wide_transect, paste0(Data_Loc,  "Data_FISH_taxa_wide.rds") )

kelp_wide_transect = kelp_transect[,c('year','site','transect','area','zone','species','density')] %>%
                      rename(taxa = species) %>%
                      pivot_wider( values_from = density, names_from = taxa, values_fill = 0 )
saveRDS(kelp_wide_transect, paste0(Data_Loc,   "Data_KELP_wide.rds") )

invert_wide_transect = pivot_wider(invert_transect_taxa[,c('year','site','transect','area','zone','density','taxa')] ,
                        values_from = density, names_from = taxa, values_fill = 0 )
saveRDS(invert_wide_transect, paste0(Data_Loc,"Data_INVERT_wide.rds") )


#### capscale analyses ####
#### fish_kelp ####
#### summarize fish and kelp by area because not on same transects


kelp_area <-  kelp_transect %>% group_by(site,year,area, zone, species) %>% 
                  summarise(Mean=mean(density, na.rm = TRUE),
                            SD=sd(density),N=length(density), 
                            SE=SD/sqrt(N),SE_var=SE^2) %>%
                  mutate(taxa = species) 

fish_area <-  fish_transect_taxa %>% group_by(site,year,area, zone, taxa) %>%
                  summarise(Mean=mean(Count, na.rm = TRUE),
                            SD=sd(Count),N=length(Count), 
                            SE=SD/sqrt(N),SE_var=SE^2)

kelp_wide = kelp_area[,c('year','site','area','zone','taxa','Mean')] %>%
                    rename(mean = Mean) %>%
                    pivot_wider( .,values_from = mean, names_from = taxa, values_fill = 0 )

fish_wide = fish_area[,c('year','site','area','zone','Mean','taxa')] %>%
                    rename(mean = Mean)%>%
                    pivot_wider(. ,values_from = mean, names_from = taxa, values_fill = 0 )

# file has all fish data and some NA's for the kelp data (at depth where no kelp transects)
# set to zeros?
# right join would have NA's for zero visibilty sites. Use left join

fish_kelp_wide <- fish_wide %>% left_join(kelp_wide, by=c('site'='site','year'='year','area'='area','zone'='zone'))

saveRDS(fish_kelp_wide, file=paste0(Data_Loc,'Data_Fish_Kelp_area_wide.rds'))


##### invert_kelp ####
# combine at transect level because on the same transects

# note, there are no algae data for Neah Bay S in 2016.

invert_kelp_wide <- invert_wide_transect %>% full_join(kelp_wide_transect, 
                    by=c('site'='site','year'='year','area'='area','zone'='zone', 'transect'='transect'))

saveRDS(invert_kelp_wide, file=paste0(Data_Loc,'Data_Inverts_Kelp_transect_wide.rds'))


```

# Quick view of what species to include in kelp ordinations. Basically only the big three have any abundance.

## Algae  


```{r quick-kelp-plots, fig.width=6, fig.height=8}

kelpx <- kelp_transect %>% group_by(species,year) %>% summarise(Mean = mean(density))
                    
ggplot( kelpx , aes(x=year, y = Mean ) ) +
        geom_point() +
        facet_wrap(facets = 'species', ncol=2) +# , scales = 'free_y')+
        theme_bw()+ theme_nt
       


```

## Fish  

Note, the y-axes are very different 

```{r quick-fish-plots, fig.width=6.5, fig.height=8}

fishx <- fish_transect_taxa %>% group_by(taxa,year) %>% summarise(Mean = mean(Count))
                    
ggplot( fishx , aes(x=year, y = Mean ) ) +
        geom_point() +
        facet_wrap(facets = 'taxa', ncol=4 , scales = 'free_y')+
        theme_bw()+ theme_nt


```
  
### NOTES  
for multivariate analysis; cut and paste to that file

fish.spp =   c("OPEL", "HEXA", "SECA", "SCMA" ,"SENE", "SEME", 'EMBI','GOBI')

yoy.spp =    c("SECAyoy", "SEPIyoy", "SEMYyoy", "SEBYTyoy","RYOY")

# SOME USEFUL TABLES

```{r fish-table , results='asis' }

fish_total <- fish_transect %>% group_by(species) %>%
                                summarise(Total = sum(Count, na.rm = TRUE)) %>%
                                left_join(.,fish_codes, by = c('species' = 'code'))
# fish_total = na.omit(fish_total)

fish_total$spp <- str_replace(fish_total$spp, "_", " ")
fish_total$com_name <- str_replace(fish_total$com_name, "_", " ")
fish_total$spp <- str_replace(fish_total$spp, "[.]", " ")

fish_total <- fish_total[,c('spp', 'com_name', 'group', 'Total')] %>%
              rename(Species = spp) %>%
              rename('Common name' = com_name) %>%
              rename (Group=group)
library(tinytex)
#library(xtable)
library(htmlTable)

# fish_total <- data.frame(fish_total)
#print(xtable(fish_total , type='html'))

fish_total <- fish_total[ order(fish_total$Total, decreasing = TRUE),]
head(fish_total)

write.csv(fish_total, paste0(Fig_Loc,"Table-Fish-Table.csv"))

#knitr::kable(fish_total)

```



```{r kelp-table}

kelp_total <- kelp_transect %>% group_by(species) %>%
                                summarise(Density = mean(density, na.rm = TRUE)) %>%
                                left_join(.,kelp_codes, by = c('species' = 'species')) %>%
                                rename(spp = species) %>%
                                rename(Species = name2) 
                                
kelp_total <- kelp_total[,c('Species','Density')]
kelp_total <- kelp_total[order(kelp_total$Density, decreasing = TRUE ),]

# head(kelp_total)
# output csv for table in supplement
write.csv(kelp_total, paste0(Fig_Loc,"Table-Kelp-Table.csv"))

```


```{r invert-table}

invert_total <- invert_transect %>% rename(SPP = species) %>%
                                group_by(SPP) %>%
                                summarise(Density = mean(density, na.rm = TRUE), 
                                          Total = sum(total.count, na.rm = TRUE)) %>%
                                left_join(.,swath_codes, by = c('SPP' = 'CLASSCODE')) %>%
                                rename(Taxa = taxa) %>%
                                rename(Species = species)


                                
invert_total <- invert_total[,c('Species','Taxa','Total','Density')]
invert_total <- invert_total[ order (invert_total$Total, decreasing = TRUE ),]

head(invert_total)
# output csv for table in supplement
write.csv(invert_total, paste0(Fig_Loc,"Table-Inverts-Table.csv"))

```


# Kelp Canopy

Imports data file from other R file. Plot just kelp canopy. Add to ggarrange below.


```{r kelp-canopy}

canopy = readRDS( paste0(Data_Loc, "Data_Kelp_Canopy_Long.rds") )

canopy$species = factor(canopy$species, levels = c('Total','Macrocystis','Nereocystis'))

canopy.kelp <- ggplot( canopy %>% filter(., site == 'Coastwide') %>% filter(., year %in% 2015:2021), 
                       aes(x=year, y = canopy_ha, color = species)) +
                geom_point() +
                geom_line() +
                xlab("") +
                scale_x_continuous(breaks=seq(2015,2021)) +
                scale_y_continuous("Canopy area (ha)") +
                scale_color_manual(values = site.col$col[c(5,1,2,3)],
                                   labels = c('Total',expression(italic('Macrocystis')),expression(italic('Nereocystis'))) )+
                # scale_color_viridis_d(begin=0,end=0.75,option="plasma") +
                theme_bw() + theme_nt + 
                theme(legend.key.size = unit(0.5,'lines') )            


canopy.kelp

```


# Combined Figures for MS

```{r Figure-2-Combined, fig.width=6, fig.height=6}

# library(ggpubr)
canopy.kelp <- canopy.kelp + theme(legend.position = c(0.75 , 0.65) )
kelp_coast5 <- kelp_coast5 + theme(legend.position = c(0.30 , 0.85) )
urchin.plot <- urchin.plot + theme(legend.position = c(0.30 , 0.85) )
stars_year  <- stars_year  + theme(legend.position = c(0.50 , 0.80) )
fish.plot   <- fish.plot   + theme(legend.position = c(0.60 , 0.40) ) + guides(color=guide_legend(ncol=2))
yoy.plot    <- yoy.plot    + theme(legend.position = c(0.70 , 0.70) )

ggarrange(
  canopy.kelp, kelp_coast5, urchin.plot, stars_year, fish.plot,yoy.plot,
  labels = c('a)','b)','c)','d)', 'e)', 'f)'), 
  # labels = 'auto',
  font.label = list(face='plain', size = 10),
  hjust = c(rep(-6,5),-9),
  vjust = 2,
  nrow = 3, ncol=2,
  align = 'v'
)


```

```{r Figure-2, fig.width=4, fig.height=6}

# library(ggpubr)

kelp_coast5 <- kelp_coast5 + theme(legend.position = c(0.22,0.85) )
urchin.plot <- urchin.plot + theme(legend.position = c(0.22,0.85) )
stars_year  <- stars_year  + theme(legend.position = c(0.70,0.80) )


ggarrange(
  kelp_coast5, urchin.plot, stars_year,
  labels = c('a)','b)','c)','d)', 'e)'), 
  # labels = 'auto',
  font.label = list(face='plain', size = 10),
  hjust = -6,
  vjust = 2,
  nrow = 3, ncol=1,
  align = 'v'
)


```

```{r Figure-3, fig.width=4, fig.height=5}

# library(ggpubr)

fish.plot <- fish.plot + theme(legend.position = c(0.35,0.9) )

yoy.plot <- yoy.plot + theme(legend.position =c(0.7,0.8) )

ggarrange(
  fish.plot, yoy.plot,
  labels = c('a)','b)','c)','d)', 'e)'), 
  # labels = 'auto',
  font.label = list(face='plain', size = 10),
  hjust = -5,
  vjust = 2,
  nrow = 2, ncol=1,
  align = 'v'
)


```


