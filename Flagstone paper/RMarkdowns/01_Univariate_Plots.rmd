<<<<<<< HEAD
---
title: "Multivariate Analyses for Fish and Inverts"
author: Nick Toimieri
date: sys.date()
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
fontsize: 11pt

---


```{r SETUP, include=FALSE}
# A bunch of initial set up junk

#rm(list = ls())

# pre-run some stuff ####
# source("01a_Univariate_workhorse.R")

##### knitr stuff and libraries ####
# tools in use 
library(knitr)
library(tidyverse)
library(stringr)
library(RColorBrewer)
library(ggpubr)
#devtools::install_github("DesiQuintans/desiderata")
#library(desiderata)
# library(tidyr)
# library(dplyr)
# library(tinytex) # for pdf output

# display.brewer.all(colorblindFriendly = TRUE)
#vlibrary(readxl)

# stats packages etc
# library(vegan)
# library(BiodiversityR)
# library(pracma)
# library(factoextra)

# Paths for files

HomeFile = HomeFile = "C:/Users/nick.tolimieri/Documents/GitHub/OCNMS/"
Fig_Loc = paste0(HomeFile,"/Flagstone paper/Plots/")
Data_Loc = paste0(HomeFile,"/Flagstone paper/Data/")
Results_Loc = paste0(HomeFile,"/Flagstone paper/Results/")
Other_Files = paste0(HomeFile,"/Flagstone paper/Other Files/")

# options
knitr::opts_chunk$set(
  fig.path = Fig_Loc,
  cache.path = 'cache/graphics-', 
  echo=FALSE,
  error=FALSE,
  include = TRUE,
  dev='png',
  dpi=300,
  warning=FALSE,
  #out.width = '100%',
  fig.align='center'
  
  )

# just to keep track of when I ran things.

Last_Run0 = Sys.time()
Last_Run = str_replace(Last_Run0, ":", ".")
Last_Run = str_replace(Last_Run, ":", ".")
capture.output(Last_Run, file = 'Last_Run.txt')

par(ps=10, cex=1)

# Paths for files

HomeFile = HomeFile = "C:/Users/nick.tolimieri/Documents/GitHub/OCNMS/"
Fig_Loc = paste0(HomeFile,"/Flagstone paper/Plots/")
Data_Loc = paste0(HomeFile,"/Flagstone paper/Data/")
Results_Loc = paste0(HomeFile,"/Flagstone paper/Results/")
Other_Files = paste0(HomeFile,"/Flagstone paper/Other Files/")

source("R-functions-ocnms.r")

```

```{r triggers-and-settings}

# provided in Univariate_workhorse, sourced above
settings = readRDS( paste0(Data_Loc,'settings.RDS') )

min.vis = settings$min.vis

years = 2015:2021
pch = c(9, 4, 8 , 21, 22, 24, 25 )
col = RColorBrewer::brewer.pal(n = 12, name = "Paired")[c(2,4,6,10,12,7,8)]
year.pch = data.frame(cbind(years, pch,col))

sites = c("Neah Bay","Tatoosh Island","Cape Alava","Cape Johnson","Destruction Island")
col = RColorBrewer::brewer.pal(n = 12, name = "Paired")[c(2,4,6, 10,12)]
site.col = data.frame(cbind(sites,col))
colnames(site.col) <- c('site', 'col')

#### species depths #####

kelp.depth = settings$kelp.deph
fish.depth = settings$fish.depth
invert.depth = settings$invert.depth

### species codes here 

fish_codes = data.frame(read.csv( paste0(Data_Loc,"spp_codes_fish.csv") ))
swath_codes = data.frame(read.csv( paste0(Data_Loc,"spp_codes_swath.csv") ))
kelp_codes = data.frame(read.csv( paste0(Data_Loc,"spp_codes_kelp.csv") ))

### combine settings and save out for multivariate file  ####
# will overwrite settings file from Univariate_workhorse

settings = list(min.vis = min.vis,
                years = years,
                pch = pch,
                col=col,
                sites=sites,
                year.pch = year.pch,
                site.col = site.col,
                kelp.deph = kelp.depth,
                fish.depth = fish.depth,
                invert.depth = invert.depth,
                fish_codes = fish_codes,
                swath_codes = swath_codes)

saveRDS(settings, file = paste0(Data_Loc,'settings.RDS') )


```

# Import fish and manipulate data a bit

```{r import-fish, include=FALSE}
# read in rds file with combined data
fish0 = readRDS( paste0(Data_Loc,'Fish_2015-2021.rds' ))

# add in yoy designator and fix some names

fish0 <- fish0 %>% 
  left_join(.,fish_codes %>% dplyr::select(code,group),by=c("species"="code")) %>%
  rename(taxa=group)

fish0 <- fish0 %>% mutate(taxa=case_when(is.na(size_class)==TRUE ~ as.character(taxa),
                                         size_class=="large" ~ as.character(taxa),
                                         size_class=="small" ~ paste0(taxa,"yoy"))) %>%
                  mutate(taxa= ifelse(taxa=="RYOYyoy","RYOY",taxa))

# combine YT and black or keep separate? # COMBINE!
fish0 %>% filter(taxa %in% c('SEFLyoy','SEMEyoy','SEBYTyoy')) %>% group_by(taxa) %>% 
        summarise(Tot=sum(Count))

fish0$taxa[ fish0$taxa %in% c('SEFLyoy','SEMEyoy')] <- 'SEBYTyoy'

# Aggregate the SEBYTyoy so that there are one, not three, entries for "SEBYTyoy"
fish_yt <- fish0 %>% filter(taxa=="SEBYTyoy") %>% 
              group_by(site, transect,observer,
                       size_class,year,area,zone,vis_m,taxa) %>%
              summarise(Count_all=sum(Count)) %>% rename(Count=Count_all) %>%
              mutate(species="SEBYT",common.name=NA)
                
fish0 <- fish0 %>% filter(!taxa == "SEBYTyoy") %>% full_join(.,fish_yt)

# subset visibility ####
# add fake vis for 2015
fish0$vis_m[ fish0$year == 2015 ] <- 3
# poor vis at destruction in year 1.
fish0$vis_m[ fish0$year == 2015 & fish0$site == "Destruction Island"] <- 1

# output for multivariate ####
saveRDS(fish0, paste0(Data_Loc, "Fish_2015-2021-ntmods.rds"))

# get just five sites

fish1 = fish0 %>% filter(site %in%  sites)

# drop low vis sites/transects and set depth
fish1a = fish1[fish1$vis_m >= min.vis, ]

# select depth ####
fish1b = fish1a[fish1a$zone %in% fish.depth,]

# calculate total yoy by site, transect, observer, and year
fish1b %>% filter(size_class == "small") %>% distinct(taxa)
# all of the small taxa are rockfish YOY.

fish1c <- fish1b %>% filter(size_class == "small") %>% 
                      group_by(site,year,transect,observer,zone,area) %>% 
                      summarise(Count_all=sum(Count)) %>%
                      mutate(species="TOTyoy",taxa="TOTyoy") %>%
                      rename(Count=Count_all)
fish1d <- fish1b %>% full_join(.,fish1c) 
fish_transect <- fish1d
                    
# Ole made this to check the aggregating in fish 2.
fish3 <-  fish1d %>% group_by(site,year,zone,species, taxa) %>%
              summarise(Mean=mean(Count),SD=sd(Count),N=length(Count),SE=SD/sqrt(N))

# Check to make sure all of the site-year-zone combinations have equivalent number of transects.
fish3 %>% group_by(site,year,zone) %>% distinct(N) %>% as.data.frame()


### calculate means and se for species ####

fish4 <-  fish1d %>% group_by(site,year,species,taxa) %>%
              summarise(Mean=mean(Count),SD=sd(Count),N=length(Count),
                        SE=SD/sqrt(N),SE_var=SE^2)
saveRDS(fish4, paste0(Data_Loc,'Summarized_Data_Fish_site_year_species.rds'))

fish5 <- fish4 %>% group_by(year, species, taxa) %>%
                    summarise(grand_sum=sum(Mean),
                        N=length(Mean),
                        grand_mean= grand_sum / N,
                        grand_sum_var =sum(SE_var), 
                        grand_SE = sqrt(grand_sum_var / N^2))
saveRDS(fish5, paste0(Data_Loc,'Summarized_Data_Fish_year_species.rds'))

#### calculate means se for taxa #######
# lump by taxa for some plotting analysis.
# greenlings lumped in current plots

fish_taxa_Year_site <-  fish1d %>% group_by(site,year,taxa) %>%
  summarise(Mean=mean(Count),SD=sd(Count),N=length(Count),
            SE=SD/sqrt(N),SE_var=SE^2)
saveRDS(fish_taxa_Year_site, paste0(Data_Loc,'Summarized_Data_Fish_site_year_taxa.rds'))

fish_taxa_year <-fish_taxa_Year_site %>% group_by(year,taxa) %>%
  summarise(grand_sum=sum(Mean),
            N=length(Mean),
            grand_mean= grand_sum / N,
            grand_sum_var =sum(SE_var), 
            grand_SE = sqrt(grand_sum_var / N^2))
saveRDS(fish_taxa_year, paste0(Data_Loc,'Summarized_Data_Fish_year_taxa.rds'))


```

Minimum vis for fish analysis = `r min.vis`-m

Kelp depths = `r kelp.depth` -m
Fish depths = `r fish.depth` -m
Inv  depths = `r invert.depth` -m

Visibility data for 2015 are fake. DI was bad and set at 1.0 m; other sites set at 3.0 m

# FISH

## Rockfish YOY

```{r rockfish-yoy, fig.width=5, fig.height=3.5}

fish_taxa_year <- readRDS(paste0(Data_Loc,'Summarized_Data_Fish_year_taxa.rds'))

fish.col = c(RColorBrewer::brewer.pal(n = 12, name = "Paired"))

SP.yoy <- c("SEBYTyoy", "Black & Yellowtail",  'black',
            "SECAyoy", "Copper",               fish.col[12],
            #"SEMAyoy", "Quillback",            fish.col[10],
            "SEMYyoy", "Blue" ,                fish.col[2],
            #"SENEyoy", "China",                fish.col[10],
            "SEPIyoy", "Canary",               fish.col[6],
            "RYOY", "Unidentified",            fish.col[9],
            "TOTyoy", "Total",                 fish.col[10])

SP.yoy <- matrix(SP.yoy,ncol=3,byrow=T) %>% as.data.frame()
colnames(SP.yoy) <- c("taxa","name",'col')

SP.yoy$name <- as.character(SP.yoy$name)
SP.yoy$name <- factor(SP.yoy$name,levels=SP.yoy$name)

yoy.plot <- ggplot(fish_taxa_year %>% filter(taxa %in% SP.yoy$taxa) %>% left_join(.,SP.yoy)) +
    geom_point(aes(x=year,y=grand_mean,color=name)) + 
    geom_line(aes(x=year,y=grand_mean,color=name)) +
    geom_errorbar(aes(x=year,color=name,ymin=grand_mean-grand_SE,ymax=grand_mean+grand_SE),
                  width=0) +
    scale_y_continuous(trans="sqrt",breaks=c(0,1,5,10,20,40,60,80),limits=c(0,NA)) +
    scale_x_continuous(breaks=seq(2015,2021)) +
    #scale_color_viridis_d(option="plasma", end=0.75) + 
    scale_color_manual(values=SP.yoy$col)+
    ylab("Rockfish Recruits") +
    xlab("Year") +
    theme_bw() +
    theme(legend.title=element_blank(),
          legend.background = element_blank(),
          #legend.position = c(0.8, 0.7),
          #legend.text = element_text(size = 7)
          )

```
## Fish

Fish depth = `r fish.depth`

```{r fish, fig.width=5, fig.height=3.5}

fish_taxa_year <- readRDS(paste0(Data_Loc,'Summarized_Data_Fish_year_taxa.rds'))

fish.col = c(RColorBrewer::brewer.pal(n = 12, name = "Paired"))

fish.taxa <- c("OPEL", "Lingcod",     fish.col[10],
               "HEXA", "Greenlings", fish.col[4],
               "SCMA" ,"Cabazon",     fish.col[8],
               "SECA", "Copper RF",   fish.col[12],
               "SENE", "Blue RF",     fish.col[2],
               "SEFL", "Yellowtail RF", fish.col[7],
               "SEME", 'Black RF',    'black')

fish.taxa <- matrix(fish.taxa,ncol=3,byrow=T) %>% as.data.frame()
colnames(fish.taxa) <- c("taxa","name","col")

fish.taxa$name <- as.character(fish.taxa$name)
fish.taxa$name <- factor(fish.taxa$name,levels=fish.taxa$name)


fish.plot <- ggplot(fish_taxa_year %>% filter(taxa %in% fish.taxa$taxa) %>% left_join(.,fish.taxa)) +
  geom_point(aes(x=year,y=grand_mean,color=name)) + 
  geom_line(aes(x=year,y=grand_mean,color=name)) +
  geom_errorbar(aes(x=year,color=name,ymin=grand_mean-grand_SE,ymax=grand_mean+grand_SE),
                width=0) +
  scale_y_continuous(trans="sqrt",breaks=c(0,1,5,10,20,40,60,80),limits=c(0,NA)) +
  scale_x_continuous(breaks=seq(2015,2021)) +
  #scale_color_viridis_d(option="plasma", end=0.75) + 
  scale_color_manual(values=fish.taxa$col)+
  ylab("Fish") +
  xlab("Year") +
  theme_bw() +
  theme(legend.title=element_blank(),
        legend.background = element_blank(),
        #legend.position = c(0.7, 0.5),
        #legend.text = element_text(size = 7)
        )

```
## Fish and YOY plot 


```{r combined-fish-yoy, fig.width=5, fig.height=4}

g1 <- ggplotGrob(fish.plot)
g2 <- ggplotGrob(yoy.plot)

g <- rbind(g1, g2, size = "first")

g$widths <- grid::unit.pmax(g1$widths, g2$widths)
grid::grid.newpage()
grid::grid.draw(g)

```

# KELP / ALGAE

Kelp depth = `r kelp.depth`

```{r swath-data-import}

# read in rds file with combined data
swath0 <- readRDS( paste0(Data_Loc,'Swath_2015-2021.rds' ))
# spp_swath <- read.csv( paste0(Data_Loc,"spp_codes_swath.csv"))
# separate into algae and invertebrate data frames.

# swath1 <- left_join(swath0,spp_swath)
# just bring in higher level taxa designation
# swath0$taxa = swath_codes$taxa[ match(swath0$species, swath_codes$CLASSCODE) ]

swath1 <- swath0 %>% filter(site %in% sites)

swath1$site <- factor(swath1$site,levels=sites)

dat.algae   <- swath1 %>% filter(group=="Algae")
# functional groupings for algae
# nick made up the kelp_codes file. Ole should check FGs.
dat.algae$fun_gr = kelp_codes$functinal_group[ match(dat.algae$species, kelp_codes$species) ]

dat.invert  <- swath1 %>% filter(group=="Invert")
# higher taxa groupings for inverts; for grouping later
dat.invert$taxa = swath_codes$taxa[ match(dat.invert$species, swath_codes$CLASSCODE) ]

```

```{r more-kelp}

algae1 <- dat.algae %>% group_by(year,site,transect,observer,species,zone,area,fun_gr) %>%
            summarise(total.count=sum(Count),total.area=sum(Transect.area)) %>% 
            mutate(density = total.count / total.area )
kelp_transect <- algae1
saveRDS(algae1, file = paste0(Data_Loc,"Summarized_Data_Kelp_year_site_area_zone_spp.rds"))

# Aggregate up to the area level (within year site, zone) -- treat transects as replicates
algae2 <- algae1 %>% 
  group_by(year,site,species,zone,area,fun_gr) %>%
  summarise(mean.density=mean(density), 
            SD = sd(density), 
            N =length(year),
            SE= SD/sqrt(N) ) 
saveRDS(algae2, file = paste0(Data_Loc,"Summarized_Data_Kelp_year_site_zone_spp.rds"))


# Aggregate up to the site level (within year, zone) -- treat transects as replicates
algae3 <- algae1 %>% 
  group_by(year,site,species,zone,fun_gr) %>%
  summarise(mean.density=mean(density), 
            SD = sd(density), 
            N =length(year),
            SE= SD/sqrt(N) ) 
saveRDS(algae3, file = paste0(Data_Loc,"Summarized_Data_Kelp_year_zone_spp.rds"))

#Trim to canopy species
 canopy <- algae3 %>% filter(fun_gr=="canopy",!species=="EGRMEN")
 canopy$site <- factor(canopy$site,levels=sites)
 
 sm = 0.5
 bg = 1
 SIZE = cbind(site=sites,size=c(sm,sm,sm,bg,sm)) %>% as.data.frame()
 
 canopy <- left_join(canopy,SIZE)
 canopy$size <- as.numeric(as.character(canopy$size))
 canopy$zone <- factor(canopy$zone)
  

```


## Canopy kelp 5 meters

```{r canopy-kelp-site-year, fig.width=5, fig.height=5}

canopy$site = factor(canopy$site, levels = sites)
 # Basic time-series by site and zone
 kelp1 = ggplot(canopy %>% filter(zone==5)) +
    geom_point(aes(x=year,y=mean.density,color=site)) +
    geom_line(aes(x=year,y=mean.density,color=site)) +
    geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
    facet_grid(rows="species",scales="free_y") +
    scale_x_continuous(breaks=seq(2015,2021)) +
    xlab("Year")+
    scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
    # scale_color_viridis_d(option="plasma",end=0.75)+
    scale_color_manual(values = site.col$col)+
    theme_bw()+
    theme(legend.title = element_blank())

kelp1
```
## Caonopy kelp 5 m only

```{r canopy-kelp-site-zone, fig.width=5, fig.height=5}
 # Basic time-series by site and zone
 kelp2 = ggplot(canopy %>% filter(zone==10)) +
   geom_point(aes(x=year,y=mean.density,color=site)) +
   geom_line(aes(x=year,y=mean.density,color=site)) +
   geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
   facet_grid(rows="species",scales="free_y") +
   scale_x_continuous(breaks=seq(2015,2021)) +
   scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
   # scale_color_viridis_d(option="plasma",end=0.75)+
   scale_color_manual(values = site.col$col)+
   theme_bw()+
   theme(legend.title = element_blank())
kelp2
```
## Nerocystis at Tatoosh
```{r canopy-kelp-tatoosh , fig.width=5, fig.height=3.5}
 # Basic time-series by site and zone TATOOSH FOCUS
kelp3 =  ggplot(canopy %>% filter(site=="Tatoosh Island",species=="NERLUE")) +
   geom_point(aes(x=year,y=mean.density,color=zone),alpha=0.5) +
   geom_line(aes(x=year,y=mean.density,color=zone),alpha=0.5) +
   geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=zone),width=0) +
   #facet_grid(rows="species",scales="free_y") +
   scale_x_continuous(breaks=seq(2015,2021)) +
   scale_y_continuous(expression("Stipe density (stipe m"^-2*")"),limits=c(0,NA)) +
   scale_color_viridis_d("Depth (m)",option="plasma",end=0.75)+
   ggtitle("Tatoosh Island") +
   theme_bw()
kelp3

```
## Nero and Macro 

```{r nero-macro}
kelp_year_site_area <- 
  readRDS(  paste0(Data_Loc,"Summarized_Data_Kelp_year_site_area_zone_spp.rds") )

kelp_year_site_area$site = factor(kelp_year_site_area$site, levels = sites)

mac_ner <- kelp_year_site_area %>% filter(species %in% c("NERLUE","MACPYR"))
 
mac_ner1 <- mac_ner %>% group_by(year,site,zone,area) %>%
              summarise(mean.density=mean(density), 
                SD = sd(density), 
                N =length(year),
                SE= SD/sqrt(N) ) 
mac_ner2 <- mac_ner %>% group_by(year,site,zone) %>%
    summarise(mean.density=mean(density), 
             SD = sd(density), 
             N =length(year),
             SE= SD/sqrt(N) ) 
 
  # Basic time-series by site and zone
  all_canopy_zone <- ggplot(mac_ner2 ) +
    geom_point(aes(x=year,y=mean.density,color=site)) +
    geom_line(aes(x=year,y=mean.density,color=site)) +
    geom_errorbar(aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
    facet_grid(rows="zone",scales="free_y") +
    scale_x_continuous(breaks=seq(2015,2021)) +
    scale_y_continuous(expression("Stipe density (stipe m"^-2*")")) +
    # scale_color_viridis_d(option="plasma",end=0.75)+
    scale_color_manual(values = site.col$col)+
    theme_bw()+
    theme(legend.title = element_blank())
 all_canopy_zone
```

# INVERTEBRATES


```{r invert-data}
# data imported above with kelps

# set proper site order
dat.invert$site = factor(dat.invert$site, levels = sites)

# add a column to sum urchins and seastars
u = grep('urchin', dat.invert$taxa)
dat.invert$grp2 = 'no'
dat.invert$grp2[u] <- 'URCHIN'

s = grep('star', dat.invert$taxa)
dat.invert$grp2[s] = 'STAR'
dat.invert$grp2[dat.invert$grp2 %in% c('Pisaster','Pynopodia')] <- 'STAR'


# Aggregate up to the transect level (within year, site, area, zone)
invert_transect <- dat.invert %>% group_by(year,site,transect,observer,species,zone,area,taxa,grp2) %>%
    summarise(total.count=sum(Count),total.area=sum(Transect.area)) %>% 
    mutate(density = total.count / total.area )
saveRDS(invert_transect, file=paste0(Data_Loc , "Summarized_Data_Inverts_year_site_zone_area_transect_taxa.rds") )


# Aggregate up to the area level (within year, site, zone) -- treat transects as replicates
invert_area <- invert_transect %>% 
    group_by(year,site,species,zone,area,taxa) %>%
    summarise(mean.density=mean(density), 
              SD = sd(density), 
              N =length(year),
              SE= SD/sqrt(N) ) 
```

## Summed Urchins 

Ole will want to clean up the figure

```{r urchins-combined, fig.width=5, fig.height=4}
  # Zoom in on urchins
urchin1 <- invert_transect %>% filter(grp2=="URCHIN") %>%
    group_by(year,site,transect,observer,zone,area,grp2) %>%
    summarise(tot.density = sum(density)) %>% 
    group_by(year,site,zone,area,grp2) %>%
    summarise(mean.density=mean(tot.density), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) ) 
 
urchin2 <- invert_transect %>% filter(grp2=="URCHIN") %>%
    group_by(year,site,transect,observer,area,zone,grp2) %>%
    summarise(tot.density = sum(density)) %>% 
    group_by(year,site,zone,grp2) %>%
    summarise(mean.density=mean(tot.density), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) ) 
  
ggplot() +
     # geom_point(data= urchin1,aes(x=year,y=mean.density,color=site)) +
      geom_point(data= urchin2,aes(x=year,y=mean.density,color=site)) +
      geom_line(data= urchin2,
                 aes(x=year,y=mean.density,color=site)) +
      geom_errorbar(data=urchin2,aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
      facet_grid(rows="zone") + #,scales="free_y") +
      scale_x_continuous(breaks=seq(2015,2021)) +
      scale_y_continuous(expression("Urchin density (m"^-2*")")) +
      # scale_color_viridis_d(option="plasma",end=0.75)+
      scale_color_manual(values = site.col$col)+
      theme_bw()+
      theme(legend.title = element_blank())
   

```

## Urchins by species

Probably worth dropping into the supplement to show that it was mostly purple urchins. Partly interesting because there is no purple urchin fishery, but there is a red one. I think.

```{r urchins-by-species, fig.width=6.5, fig.height=4}

urchins_all <- invert_transect %>% filter(grp2=="URCHIN") %>%
    group_by(year,site,transect,observer,zone,area,taxa) %>%
    summarise(tot.density = sum(density)) %>% 
    group_by(year,site,zone,taxa) %>%
    summarise(mean.density=mean(tot.density), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) )
# fix some names

urchins_all$taxa[urchins_all$taxa=='purple urchin'] <- 'Purple urchin'
urchins_all$taxa[urchins_all$taxa=='red urchin'] <- 'Red urchin'
urchins_all$taxa[urchins_all$taxa=='green urchin'] <- 'Green urchin'

# set factor level order
urchins_all$taxa = factor(urchins_all$taxa, levels = c('Purple urchin','Red urchin','Green urchin'))
# plot 

urchin5  <- filter(urchins_all , zone == 5)
urchin10 <- filter(urchins_all , zone == 10)

urchin_plot_all <- ggplot(data=urchins_all,aes(x=year, y= mean.density, col = site)) +
                    #geom_point(data=urchin5,aes(x=year, y= mean.density, col = site) ) +
                    #geom_line(data=urchin5, aes(x=year, y= mean.density, col = site) ) +
                    geom_point() +
                    geom_line()+
                    geom_errorbar(data=urchin5,
                                  aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
                    #facet_grid(rows="taxa") + 
                    facet_grid( taxa ~ zone) +
                    scale_color_manual(values = site.col$col) +
                    scale_x_continuous("Year", breaks=seq(2015,2021)) +
                    scale_y_continuous(expression("Urchin density (m"^-2*")")) +
                    theme_bw()+
                    theme(legend.title = element_blank(),
                          axis.text.x = element_text(size=10))
  
urchin_plot_all + rotate_x_text(angle = 45)

```
facet_grid(rows="zone") + #,scales="free_y") +

## Seastars

```{r seastars-sum}


star_sum <- invert_transect %>% filter(grp2=="STAR") %>%
    group_by(year,site,transect,observer,area,zone,grp2) %>%
    summarise(tot.density = sum(density)) %>% 
    group_by(year,site,zone,grp2) %>%
    summarise(mean.density=mean(tot.density), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) ) 

ggplot() +
      geom_point(data= star_sum,aes(x=year,y=mean.density,color=site)) +
      geom_line(data= star_sum,
                 aes(x=year,y=mean.density,color=site)) +
      geom_errorbar(data=star_sum,aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
      facet_grid(rows="zone") + #,scales="free_y") +
      scale_x_continuous(breaks=seq(2015,2021)) +
      scale_y_continuous(expression("Star density (m"^-2*")")) +
      # scale_color_viridis_d(option="plasma",end=0.75)+
      scale_color_manual(values = site.col$col)+
      theme_bw()+
      theme(legend.title = element_blank())



```
Ugly..no aliby..

```{r seastars-all}

stars_all <- invert_transect %>% filter(.,grp2 == 'STAR') %>%
    group_by(year,site,transect,observer,zone,area,taxa) %>%
    summarise(tot.density = sum(density)) %>% 
    group_by(year,site,zone,taxa) %>%
    summarise(mean.density=mean(tot.density), 
              SD = sd(tot.density), 
              N =length(year),
              SE= SD/sqrt(N) )

stars_plot_all <- ggplot(data=stars_all,aes(x=year, y= mean.density, col = site)) +
                    #geom_point(data=urchin5,aes(x=year, y= mean.density, col = site) ) +
                    #geom_line(data=urchin5, aes(x=year, y= mean.density, col = site) ) +
                    geom_point() +
                    geom_line()+
                    geom_errorbar(data=urchin5,
                                  aes(x=year,ymin=mean.density-SE,ymax=mean.density+SE,color=site),width=0) +
                    #facet_grid(rows="taxa") + 
                    facet_grid( taxa ~ zone) +
                    scale_color_manual(values = site.col$col) +
                    scale_x_continuous("Year", breaks=seq(2015,2021)) +
                    scale_y_continuous(expression("Urchin density (m"^-2*")")) +
                    theme_bw()+
                    theme(legend.title = element_blank())
  
stars_plot_all

```

# Output data for multivariate statistics



## Combine kelp, fish, and inverts for capscale analysis

```{r spit-out-kelp-fish-4-multivariate, include = FALSE}
fish_transect$area[fish_transect$year == 2015] <- 1
kelp_transect$area[kelp_transect$year == 2015] <- 1


k1 <-  kelp_transect %>% group_by(site,year,area, zone, species) %>% 
                  summarise(Mean=mean(density),SD=sd(density),N=length(density), 
                            SE=SD/sqrt(N),SE_var=SE^2) %>%
                  mutate(taxa = species) 

f1 <-  fish_transect %>% group_by(site,year,area, zone, taxa) %>%
                  summarise(Mean=mean(Count),SD=sd(Count),N=length(Count), SE=SD/sqrt(N),SE_var=SE^2)

i1 <-  kelp_transect %>% group_by(site,year,area, zone, species) %>% 
                  summarise(Mean=mean(density),SD=sd(density),N=length(density), 
                            SE=SD/sqrt(N),SE_var=SE^2)

# joined at the area level because transects aren't the same

# Output for capscale analyses
fish_kelp <- f1 %>% full_join(. , y=k1)
saveRDS(fish_kelp, paste0(Data_Loc, "Multivariate_Data_Fish_Kelp.rds") )
# combine inverts at transect level

invert_kelp <- kelp_transect %>% full_join(., y=invert_transect)
saveRDS(invert_kelp, paste0(Data_Loc,"Multivariate_Data_Invert_Kelp.rds") )

# output for CAPdiscrim analyses ####
saveRDS(fish_transect, paste0(Data_Loc,  "Multivariate_Data_FISH.rds") )
saveRDS(kelp_transect, paste0(Data_Loc,  "Multivariate_Data_KELP.rds") )
saveRDS(invert_transect, paste0(Data_Loc,"Multivariate_Data_INVERT_Kelp.rds") )

```



