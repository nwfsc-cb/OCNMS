---
title: "Summarise OCNMS UPC Percent Cover Data"
output:
  html_document: default
---
This uses 2016-2019 data, 2015 UPC uses quadrats and is inconsistent with later methods. 

```{r setup,message=FALSE, warning=FALSE}
#to load data make sure directory is set to knit from project directory
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
 
library(here)
library(tidyverse)
library(knitr)
library(viridis)
 
substrate_codes <- read_csv(here("Data","CSV_2015_on","substrate_codes.csv"))
 
#2016 --> 2019
dat.upc <- read_csv(here("Data","CSV_2015_on","NWFSC_UPC_ALLYEARS_data_2019.csv")) %>% 
              filter(CATEGORY == "COVER") %>%
              select(1:20) %>%
              rename(DEPTH.FT= "DEPTH (FT)")  %>%
              #mutate(QUADRAT = NA, PERCENT.COVER = NA) %>% #will circle back tothis and get % cover for 2016 to 2019 data 
              select(SITE, MONTH, DAY, YEAR, OBSERVER, TRANSECT , CLASSCODE, COUNT,DEPTH.FT,SIDE,ZONE,TRANSECT,BUDDY,SEGMENT) %>%
#dat.upc <- rbind(dat.2015, dat.2016) %>%
 mutate(COUNT = replace_na(COUNT, 0)) %>%
 left_join(substrate_codes) %>% #rename two that arent in substrate key
 mutate(NAME = case_when(CLASSCODE == "ptero" | NAME == "Pterogophora" ~ "Pterygophora",
                          CLASSCODE == "shell" ~ "various bivalves",
                          TRUE ~ NAME),
#ASSIGN FUNCTIONAL GROUPS 
         Functional_Group = case_when(
                                    NAME %in% c("Red algae (branching flat blade)", "Red algae (cylindrical branches)", "Red algae (lacy branching)", "Red algae (leaf-like)") ~ "Red Algae",
                                    NAME %in% c("articulated coralline","Encrusting hydrocoral (eg. Stylantheca)","Red algae -Encrusting", "Coralline algae -Crustose") ~ "Encrusting Species",
                                    NAME %in% c("Pterygophora", "Brown algae understory prone","Nereocystis holdfast (alive)", "Macrosystis holdfast (alive)", "Laminariales holdfast (alive)") ~ "Brown Algae (Understory)",
                                    NAME %in% c("urchin", "Cucumaria spp.' sea cucumber") ~ "Echinoderm", 
                                    NAME %in% c("various bivalves", "Scallop") ~ "Bivalve",
                                    NAME %in% c("Anemone", "Bryozoan", "Cup Coral","Tunicate -Colonial,compund,social","Tunicate -Solitary", "Hydroid", "Sponge", "Barnacle","Tubeworm") ~ "Non-mobile Invertebrate",
                                    NAME %in% c("Substrate: Bedrock","Shell Debris","Bare Sand", "Substrate: Cobble","Sediment/Mud", "Substrate: Sand","Bare Rock" ) ~ "Non-living Substrate",
                                    NAME %in% c("Zostera marina, eelgrass" , "Phyllospadix spp.' surfgrass") ~ "Eelgrass_Surfgrass",
                                    TRUE ~ NAME),
 #ASSIGN ORGANISM GROUPS         
        Organism_Group = case_when(NAME %in% c("Red algae (branching flat blade)", "Red algae (cylindrical branches", "Red algae (lacy branching)","Pterygophora", "Brown algae understory prone","Red algae -Encrusting", "Coralline algae -Crustose","Nereocystis holdfast (alive)","Macrosystis holdfast (alive)","Phyllospadix spp.' surfgrass", "Zostera marina, eelgrass","Encrusting hydrocoral (eg. Stylantheca)","Green algae","Laminariales holdfast (alive)","articulated coralline", "Red algae (cylindrical branches)","Red algae (leaf-like)") ~ "Plant_Algae",
                                    NAME %in% c("various bivalves", "Scallop","Anemone", "Cup Coral","Barnacle","Tunicate -Colonial,compund,social", "Tunicate -Solitary","urchin","Bryozoan","Diatom Layer","Sponge","Tubeworm","Hydroid", "Cucumaria spp.' sea cucumber") ~ "Invertebrate",
                                    NAME %in% c("Substrate: Bedrock","Shell Debris","Bare Sand", "Substrate: Cobble","Sediment/Mud", "Substrate: Sand","Bare Rock" ) ~ "Non-living Substrate", 
                                    TRUE ~ NAME))  


#rm(dat.2016,dat.2015) 

unique(dat.upc$Functional_Group)

```

```{r , echo=FALSE}
summary_table<- dat.upc %>%
  group_by(Organism_Group,Functional_Group, NAME) %>%
  summarise(species_occurence = sum(COUNT))  
 
kable(summary_table)
```

Here are some plots that show what the total species occurence looks like in different categories. 
```{r }
dat.upc %>%
  group_by(NAME) %>%
  summarise(species_occurence = sum(COUNT)) %>%
  ggplot() +
  geom_bar(aes(x=reorder(NAME, -species_occurence), y = species_occurence), stat = "identity")+ 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  xlab("Original Species Groups") +
  ylab("Species Count")
```

```{r}
dat.upc %>%
  group_by(Functional_Group) %>%
  summarise(species_occurence = sum(COUNT)) %>%
  ggplot() +
  geom_bar(aes(x=reorder(Functional_Group, -species_occurence), y = species_occurence), stat = "identity")+ 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  xlab("Functional Groups") +
  ylab("Species Count")
```

```{r}
dat.upc %>%
  group_by(Organism_Group) %>%
  summarise(species_occurence = sum(COUNT)) %>%
  ggplot() +
  geom_bar(aes(x=reorder(Organism_Group, -species_occurence), y = species_occurence), stat = "identity")+ 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  xlab("Organism Groups") +
  ylab("Species Count")
```


- Create data frame that has replication on transect level-- this can be used for future analyses. But I summarize across other columns for the plots. I used percent cover at the ZONE/SIDE/SITE/YEAR I used the mean % cover for transects within each depth zone. There are only 11 transects in whole dataset that have less than 30 upc counts (aka an incomplete transect)... In the cases where it is less than 30 I get total % cover from the total points sampled for that transect. 
This data frame is called: dat.transect.replicates.

\n Question about SIDE:
\n 2018/2019 SIDE is 0, but for 2016/2017 SIDE is either 1 or 2.  

```{r}
dat.transect.summary <- dat.upc %>%
  filter(YEAR > 2015) %>%
  group_by(YEAR,SITE,SIDE,ZONE,TRANSECT,DEPTH.FT,Functional_Group) %>%
  summarise(COUNT = sum(COUNT)) %>%
  spread(Functional_Group, COUNT) %>%
  ungroup() %>%
  replace(is.na(.), 0) %>%
  dplyr::mutate(Sum = rowSums(.[,7:16])) %>%
  tidyr::gather(7:16, key = "Functional_Group", value = "COUNT") %>%
  mutate(percent_cover = COUNT/Sum) 
```


```{r}
dat.zone.summary <- dat.transect.summary %>%
  group_by(YEAR,SITE,ZONE,Functional_Group) %>% 
  summarise(mean_percent_cover = mean(percent_cover), variance = var(percent_cover)) %>% 
  ungroup() %>%
  mutate(SITE = factor(SITE, levels = c("Destruction Island","Cape Johnson", "Cape Alava","Tatoosh Island","Neah Bay")))
```

Now plot percent cover at depth/site through time. 

```{r, echo=FALSE}
ggplot(dat.zone.summary,aes(x=YEAR)) +
  geom_bar(aes(y=mean_percent_cover, fill= Functional_Group), position="fill", stat="identity",width = 0.95
           )+
  scale_fill_viridis(discrete = T) + #,  guide = guide_legend(reverse = TRUE), name = "Stock") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "left",aspect.ratio = 3/1)  +
  theme_classic()+
  ylab("Mean Percent Cover") +
  xlab("Year") +
  facet_grid(ZONE~SITE) +
 # coord_flip() +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0)) +
  theme(legend.position="left") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), strip.text.x = element_text(size = 7))
```


Also see what it looks like if I lump across years and zones, largest differences across zones seem to be increased brown algae in 5m zone and sligthly higher functional group richness in shallower areas. 

```{r}
dat.site.summary <- dat.transect.summary %>%
  group_by(SITE,Functional_Group) %>% 
  summarise(mean_percent_cover = mean(percent_cover), variance = var(percent_cover)) %>% 
  ungroup() %>%
  mutate(SITE = factor(SITE, levels = c("Destruction Island","Cape Johnson", "Cape Alava","Tatoosh Island","Neah Bay")))

```

```{r, echo=FALSE}
ggplot(dat.site.summary,aes(x=SITE)) +
  geom_bar(aes(y=mean_percent_cover, fill= Functional_Group), position="fill", stat="identity",width = 0.95
           )+
  scale_fill_viridis(discrete = T) + #,  guide = guide_legend(reverse = TRUE), name = "Stock") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "left",aspect.ratio = 3/1)  +
  theme_classic()+
  ylab("Mean Percent Cover") +
  xlab("Year") +
  #facet_wrap(~ZONE, nrow =1) +
  scale_x_discrete(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0)) +
  theme(legend.position="left") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), strip.text.x = element_text(size = 7))
```


## Potential Next Steps?
- Filter out species that only show up on <5% of transects
- Look at substrate communities in ordination space







 
