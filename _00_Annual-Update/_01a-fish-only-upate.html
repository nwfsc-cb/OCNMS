<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nick Toimieri">

<title>Univariate summary plots - fish only</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="_01a-fish-only-upate_files/libs/clipboard/clipboard.min.js"></script>
<script src="_01a-fish-only-upate_files/libs/quarto-html/quarto.js"></script>
<script src="_01a-fish-only-upate_files/libs/quarto-html/popper.min.js"></script>
<script src="_01a-fish-only-upate_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="_01a-fish-only-upate_files/libs/quarto-html/anchor.min.js"></script>
<link href="_01a-fish-only-upate_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="_01a-fish-only-upate_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="_01a-fish-only-upate_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="_01a-fish-only-upate_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="_01a-fish-only-upate_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Univariate summary plots - fish only</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nick Toimieri </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Invalid Date</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="notes" class="level1">
<h1>NOTES</h1>
<p>To update fish data to the most recent year, run:</p>
<ul>
<li>update_swath_fish.R</li>
<li>update_swath_inverts.R</li>
</ul>
<p>in the ‘update-data’ chunk. The update is done automatically within this RMD, but you will need to check that the trigger is turned on in the if statement in the in the ‘update-data’ is “if(1==1)”.</p>
<p>You will also need to have:</p>
<ul>
<li>swath-process-pre-2017-data.R</li>
<li>R-functions-ocnms.R</li>
</ul>
<p>as helper files. These are in the repo.</p>
</section>
<section id="data-year" class="level1">
<h1>DATA YEAR</h1>
<p>Set the data_ _year year</p>
</section>
<section id="process-raw-data" class="level1">
<h1>Process raw data</h1>
<p>To process the raw data:</p>
<ul>
<li>copy xlxm files into from google drive into the Data folder. Put in sub-folder for that year.</li>
<li>make csv and xlsx versions of the files</li>
</ul>
<p>The xlsx version of the file is used to pull the species codes: fish_codes, swath_codes, kelp_codes.</p>
<p>HOWEVER, at present read_xlsx incorrectly loads the data files because the SIDE/AREA column has both numbers and letters. read_xlsx turns these into NAs. This change messes up the transect area calculations and doubles the estimated densities…incorrectly of course. I haven’t figured out how to fix that yet.</p>
<p>Processed data are saved to: “~/GitHub/OCNMS/Data/2024/” or whatever the current data_year is.</p>
<p><strong>Needs to be updated</strong></p>
<section id="bring-in-data-and-species-codes" class="level2">
<h2 class="anchored" data-anchor-id="bring-in-data-and-species-codes">Bring in data and species codes</h2>
<p>This chunk will load the species codes and run the update files to turn the raw data files into counts by size and transect. Once you’ve run it, you can turn of the data processing part and just load the species codes. The chunk runs:</p>
<ul>
<li>update-swath-fish.r</li>
<li>update-swath-inverts.r (includes algae)</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Loading fish"
[1] "Running fish"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Finished fish"</code></pre>
</div>
</div>
</section>
</section>
<section id="data-import" class="level1">
<h1>Data import</h1>
<p>Bring in the initially processed data</p>
</section>
<section id="triggers-and-settings" class="level1">
<h1>Triggers and Settings</h1>
<p>I set some common settings here. The settings.rds file ports the same info over to the multivariate rmd. It is brought in and updated here.</p>
<section id="set-a-common-theme-for-plots" class="level2">
<h2 class="anchored" data-anchor-id="set-a-common-theme-for-plots">Set a common theme for plots</h2>
</section>
</section>
<section id="manipulate-fish-data-prior-to-plotting." class="level1">
<h1>Manipulate fish data prior to plotting.</h1>
<p>Raw data are fish counts by size, so there are multiple observations per species per transect. Sum up counts by transect.</p>
</section>
<section id="some-basic-information-for-summing-and-analyses-below" class="level1">
<h1>Some basic information for summing and analyses below</h1>
<p>Minimum vis for fish analysis = 2-m</p>
<p>Kelp depths = 5 -m Fish depths = 5, 10 -m Inv depths = 5 -m</p>
<p>Visibility data for 2015 are fake. DI was bad and set at 1.0 m; other sites set at 3.0 m</p>
</section>
<section id="fish" class="level1">
<h1>FISH</h1>
<section id="rockfish-yoy---coastwide" class="level2">
<h2 class="anchored" data-anchor-id="rockfish-yoy---coastwide">Rockfish YOY - coastwide</h2>
<p>Mean abundance of YOY rockfish, averaged across all sites.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'site', 'year'. You can override using the
`.groups` argument.
`summarise()` has grouped output by 'year'. You can override using the
`.groups` argument.
Joining with `by = join_by(taxa)`</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="C-/Users/Nick.Tolimieri/Documents/GitHub/OCNMS/_00_Annual-Update/figures/rockfish-yoy-1.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adult-fish---coastwide" class="level2">
<h2 class="anchored" data-anchor-id="adult-fish---coastwide">Adult fish - coastwide</h2>
<p>Species mean abundance across sites for depths listed below.</p>
<p>Fish depth = 5, 10</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(taxa)`</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="C-/Users/Nick.Tolimieri/Documents/GitHub/OCNMS/_00_Annual-Update/figures/fish-1.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adult-fish---site-x-year-x-depth" class="level2">
<h2 class="anchored" data-anchor-id="adult-fish---site-x-year-x-depth">Adult Fish - site x year x depth</h2>
<p>Species mean abundance by site x year x depth</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(taxa)`</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="C-/Users/Nick.Tolimieri/Documents/GitHub/OCNMS/_00_Annual-Update/figures/supplement-fish-site-year-1.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="yoy-rockfish-abundance---site-x-year-x-depth" class="level2">
<h2 class="anchored" data-anchor-id="yoy-rockfish-abundance---site-x-year-x-depth">YOY rockfish abundance - site x year x depth</h2>
<p>Species mean abundance by site x year x depth</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(taxa)`</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="C-/Users/Nick.Tolimieri/Documents/GitHub/OCNMS/_00_Annual-Update/figures/supplement-yoy-site-year-1.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>