---
title: "Black Rockfish Analysis OCNMS"
author: "Ole Shelton"
date: "1/17/2023"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(xtable)

# This is a padded data.frame which includes all transects
# includes zero observations
# includes low visibility transects which will be dropped.
dat.fish <- readRDS("Fish_2015-2022.rds")

# Filter to include only black rockfish or "small" size category (rockfish YOY)
dat.bk <- dat.fish %>% filter(species %in% c("SEME")) %>%
              bind_rows(.,
                dat.fish %>% filter(size_class %in% c("small")))

# Drop transects where the visibility is less than the visibility threshold (2m):
VIS_LIM <- 2
dat.bk <- dat.bk %>% filter(vis_m >= VIS_LIM)

```

# Data description
These are some analyses based on the 2015-22 survey data for fish. I've done a bunch of processing in the Git repo (file "/GitHub/OCNMS/R scripts/Fish, Invert, Kelp Analysis/Swath Fish.R") for all of the species. We have filtered out the just the black rockfish data for this analysis. 

First, we can look at the sampling locations of our survey. 

INSERT MAP HERE.

## Insert methods description

All fish density and size data were collected during SCUBA surveys 



Here is how the number fish transects with visibility >2m were distributed across sites and years.  The number of transects at 5m and 10m are combined in this table.  2015 includes only surveys conducted at 5m depth. Other years have data approximately evenly split between 5m and 10m depths.

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(xtable)

# here are the sites ordered from S to N
nom <- c("Destruction Island","Teahwhit Head","Cape Johnson","Rock 305","Cape Alava","Point of the Arches","Anderson Point","Tatoosh Island","Chibadehl Rocks","Neah Bay")
N.trans <- dat.bk %>% distinct(year,site,zone,transect,observer) %>% group_by(year,site,zone) %>%
              dplyr::summarise(N=length(transect))
N.trans.site.year <- N.trans %>% group_by (year,site) %>% summarise(N=sum(N))

N.trans$site <- factor(N.trans$site,levels=nom)
N.trans.site.year$site <- factor(N.trans.site.year$site,levels=nom)

N.trans <- N.trans %>% arrange(site)
#A <- left_join(A,nom.merge,by=c("site"="nom"))
N.trans.1 <- pivot_wider(N.trans, id_cols = c("year","zone"),
                                names_from=c("site"),
                                values_from=c("N")) 
N.trans.site.year <- N.trans.site.year %>% arrange(site,year)
N.trans.2 <- pivot_wider(N.trans.site.year, id_cols = c("year"),
                                names_from=c("site"),
                                values_from=c("N")) 
N.trans.site.year <- N.trans.site.year %>% arrange(year)
N.trans.3 <- pivot_wider(N.trans.site.year, id_cols =c("site") ,
                                names_from= c("year"),
                                values_from=c("N")) 

N.trans.2[is.na(N.trans.2)] <- 0
N.trans.3[is.na(N.trans.3)] <- 0
N.trans.2 <- N.trans.2 %>% arrange(year)

N.trans.3$site <- factor(N.trans.3$site,levels=nom)
N.trans.3 <- N.trans.3 %>% arrange(site)

N.trans.1[is.na(N.trans.1)] <- 0
N.trans.1 <- N.trans.1 %>%ungroup() %>% dplyr::select(-year,-zone) %>% mutate(Total= rowSums(.)) %>%
              pull(Total) %>%
              bind_cols(N.trans.1,.) %>%
              arrange(year,zone)
colnames(N.trans.1)[ncol(N.trans.1)] <- "Total"

N.trans.3 <- N.trans.3 %>% dplyr::select(-site) %>% colSums(.) %>% data.frame() %>% 
                t() %>% bind_cols(site="TOTAL",.) %>% bind_rows(N.trans.3,.)
```

```{r echo=FALSE} 
library(knitr)
kable(N.trans.1)
``` 

\newpage
```{r echo=FALSE} 
kable(N.trans.3)
``` 

#  Abundance trends

## Large (>10 cm total length) Black rockfish trends

To calculate the average density of black rockfish in each year, we first calculate the mean density and standard error per site in each year. This approach means we are treating each transect as a i.i.d. sample of black rockfish density within each site and thus we ignore differences in abundance by depth zone.

```{r echo=FALSE, warning=F,message=FALSE} 
# GENERATE INDEXES BY SITE and AMONG SITES
dat.bk.summary <- dat.bk %>% filter(size_class=="large")
  
#check to see that this only contains large black rockfish (should be species "SEME")
#dat.bk.summary %>% distinct(species,year,size_class)
  
# summarize using means and standard errors
dat.bk.summary <- dat.bk.summary %>%
                    group_by(year,site,species) %>% 
                    summarise(Mean=mean(Count),
                              VAR = var(Count),
                              SD=sd(Count),
                              N=length(Count),
                              SE=SD/sqrt(N))

# This is a simple calculation treating the means from each site as observed and iid samples of a grand Mean
dat.bk.out.A <- dat.bk.summary %>%
                  group_by(year)  %>%
                  summarise(grand.mean = mean(Mean),
                            N= length(Mean),
                            SE = sd(Mean)/sqrt(N))

      # We have a bunch of 0 observations, which preclude using weighting by the SE.
      # I looked extensively at two stage sampling expressions 
      # for design based estimators. 
      # They were complicated and didn't necessarily work for our design.  
      # Plus, they have troubles with the zero observations that we have.  
      # So I decided to simulate to determine the uncertainty.

#dim(dat.bk.summary)
n.sim <- 100000

sim <- matrix(# simulate from a centered t-distribution.
        rt(nrow(dat.bk.summary) * n.sim,dat.bk.summary$N - 1) * dat.bk.summary$SE +
                dat.bk.summary$Mean, # Adjust to a different location and scale.
                nrow(dat.bk.summary), n.sim) # Put it in a matrix.
sim[sim <0] <- 0
sim <- as.data.frame(sim)
colnames(sim) <- paste0("X",1:ncol(sim))

sim <- bind_cols(dat.bk.summary %>% dplyr::select(year,site), sim) %>%
          pivot_longer(.,cols=3:ncol(.),values_to="val",names_to="real")

bk.trend <- sim %>% group_by(year,real) %>%
          dplyr::summarise(mean.real = mean(val)) %>% ungroup() %>%
          group_by(year) %>%
          dplyr::summarise(grand.mean = mean(mean.real),
                           SE = sd(mean.real),
                           q025 = quantile(mean.real,probs=0.025),
                           q05 = quantile(mean.real,probs=0.05),
                           q25 = quantile(mean.real,probs=0.25),
                           q75 = quantile(mean.real,probs=0.75),
                           q95 = quantile(mean.real,probs=0.95),
                           q975 = quantile(mean.real,probs=0.975))

# Make black rockfish time-series plots
bk.rockfish.ts <- ggplot() + 
  geom_point(data=dat.bk.summary, aes(x=year,y=Mean),alpha=0.2) +
  geom_errorbar(data=dat.bk.summary,
                aes(x=year,ymin=Mean-SE,ymax=Mean+SE),
                width=0,
                alpha=0.2) +
  geom_point(data=bk.trend, aes(x=year,y=grand.mean),
             color="red",size=3)  +
  geom_errorbar(data=bk.trend,
                aes(x=year,ymin=q025,ymax=q975),
                width=0,
                color="red",size=0.5) +
  geom_errorbar(data=bk.trend,
                aes(x=year,ymin=q25,ymax=q75),
                width=0,
                color="red",size=1.2) +
  scale_y_continuous(expression("Black rockfish density (fish 120 m"^"-3"*")")) +
  theme_bw()
  
```

From these site-year level means, we calculated a year-specific mean density by simulation. Specifically, for each year we independently drew a mean density for each site using a t-distribution with $\mu$ (the estimated site mean), $\sigma$ (the estimated site-specific standard error) and degrees of freedom, $\tau$.  So for the $i^{th}$ realization, for site $s$ in year $y$ we have a predicted density, $X_{isy}$

\begin{align}
 & X_{isy} \sim T(\mu_{sy},\sigma_{sy},\tau_{sy}) \\
\end{align}

and then the predicted density for a single realization in a given year is the mean among sites observed. We repeat the simulation 100,000 times to provide an estimated mean density and uncertainty for a given year (Fig. \ref{fig:black.ts}) 


```{r echo=FALSE, warning=FALSE, fig.black.ts, fig.height = 4, fig.width = 6,fig.align='center',fig.cap ="\\label{fig:black.ts} Time-series of estimated black rockfish density on the Washington coast. Black points show means and standard errors for individual sites. Red points show coastwide density estimates, interquartile range and 95\\% intervals for each year."}
print(bk.rockfish.ts)
```

# Young of year black rockfish

Unlike adult black rockfish, small (<10 cm total length) rockfish cannot be unequivocally visually identified to species. In most cases, species can be identified to a complex of a few species. For small rockfish, black rockfish occur in a complex of two species, black rockfish and yellowtail rockfish.  Yellowtail rockfish are rare in Washington state and we consider their contribution to small rockfish size categories to be trivial. Nearly all small rockfish fall into the 4 to 7cm length range and all are considered to be fish that recruited to the kelp forest from the plankton during the calender year of the survey.  Therefore, we view the density of <10cm rockfish to be an indicator of black rockfish recruitment.

To derive estimates of overall young-of-year densities, we use identical methods to those described for adult rockfish densities and provide estimated densities per year for our survey area (Fig. \ref{fig:yoy.ts})


```{r echo=FALSE, warning=F,message=FALSE} 
# GENERATE INDEXES BY SITE and AMONG SITES
dat.yoy.summary <- dat.bk %>% filter(species =="SEBYT")


#check to see that this only contains large black rockfish (should be species "SEME")
#dat.bk.summary %>% distinct(species,year,size_class)
  
# summarize using means and standard errors
dat.yoy.summary <- dat.yoy.summary %>%
                    group_by(year,site,species) %>% 
                    summarise(Mean=mean(Count),
                              VAR = var(Count),
                              SD=sd(Count),
                              N=length(Count),
                              SE=SD/sqrt(N))

# This is a simple calculation treating the means from each site as observed and iid samples of a grand Mean
dat.yoy.out.A <- dat.yoy.summary %>%
                  group_by(year)  %>%
                  summarise(grand.mean = mean(Mean),
                            N= length(Mean),
                            SE = sd(Mean)/sqrt(N))

      # We have a bunch of 0 observations, which preclude using weighting by the SE.
      # I looked extensively at two stage sampling expressions 
      # for design based estimators. 
      # They were complicated and didn't necessarily work for our design.  
      # Plus, they have troubles with the zero observations that we have.  
      # So I decided to simulate to determine the uncertainty.

#dim(dat.bk.summary)
n.sim <- 100000

sim <- matrix(# simulate from a centered t-distribution.
        rt(nrow(dat.yoy.summary) * n.sim,dat.yoy.summary$N - 1) * dat.yoy.summary$SE +
                dat.yoy.summary$Mean, # Adjust to a different location and scale.
                nrow(dat.yoy.summary), n.sim) # Put it in a matrix.
sim[sim <0] <- 0
sim <- as.data.frame(sim)
colnames(sim) <- paste0("X",1:ncol(sim))

sim <- bind_cols(dat.yoy.summary %>% dplyr::select(year,site), sim) %>%
          pivot_longer(.,cols=3:ncol(.),values_to="val",names_to="real")

yoy.trend <- sim %>% group_by(year,real) %>%
          dplyr::summarise(mean.real = mean(val)) %>% ungroup() %>%
          group_by(year) %>%
          dplyr::summarise(grand.mean = mean(mean.real),
                           SE = sd(mean.real),
                           q025 = quantile(mean.real,probs=0.025),
                           q05 = quantile(mean.real,probs=0.05),
                           q25 = quantile(mean.real,probs=0.25),
                           q75 = quantile(mean.real,probs=0.75),
                           q95 = quantile(mean.real,probs=0.95),
                           q975 = quantile(mean.real,probs=0.975))

# Make black rockfish time-series plots
yoy.ts <- ggplot() + 
  geom_point(data=dat.yoy.summary, aes(x=year,y=Mean),alpha=0.2) +
  geom_errorbar(data=dat.yoy.summary,
                aes(x=year,ymin=Mean-SE,ymax=Mean+SE),
                width=0,
                alpha=0.2) +
  geom_point(data=yoy.trend, aes(x=year,y=grand.mean),
             color="blue",size=3)  +
  geom_errorbar(data=yoy.trend,
                aes(x=year,ymin=q025,ymax=q975),
                width=0,
                color="blue",size=0.5) +
  geom_errorbar(data=yoy.trend,
                aes(x=year,ymin=q25,ymax=q75),
                width=0,
                color="blue",size=1.2) +
  scale_y_sqrt(expression("Young-of-Year Density (fish 120 m"^"-3"*")"),
                  #trans="sqrt",
                  limits=c(0,NA),
                  expand=c(0,NA),
                  breaks=c(0,1,5,10,25,50,100),
                  labels=c("0","1","5","10","25","50","100")) +
  #geom_hline(yintercept=0,color="red")+
  theme_bw()
  
```


```{r echo=FALSE, warning=FALSE, fig.yoy.ts, fig.height = 4, fig.width = 6,fig.align='center',fig.cap ="\\label{fig:yoy.ts} Time-series of estimated young-of-year rockfish (black-yellowtail complex) density on the Washington coast. Black points show means and standard errors for individual sites. Blue points show coastwide density estimates, interquartile range and 95\\% intervals for each year."}
print(yoy.ts)
```

\newpage
## Information on size data for black rockfish 2015-2022

In addition to abundance data, we visually estimate size (total length) for all individuals observed during the surveys.  Young-of-year show remarkably limited variation in size ()

<!-- ```{r echo=T,warning=FALSE,fig.height = 4.25, fig.width = 7,fig.align='center'} -->
<!-- source("../R scripts/2022-23 Black Rockfish Assessment/Process Length Structure.R") -->

<!-- ``` -->

<!-- Plots of size distribution grouped into 5 cm bins. -->
<!-- ```{r echo=FALSE,warning=FALSE,fig.height = 7, fig.width = 8,fig.align='center'} -->
<!-- print(p.seme.size.bin1) -->

<!-- ``` -->


<!-- ```{r echo=FALSE,warning=FALSE,fig.width = 6, fig.height = 7,fig.align='center'} -->
<!-- print(p.seme.size.bin2) -->

<!-- ``` -->

<!-- \newpage -->
<!-- Plots of size distribution... but without 5cm bins -->

<!-- ```{r echo=FALSE,warning=FALSE,fig.width = 6, fig.height = 7,fig.align='center'} -->
<!-- print(p.seme.size2) -->

<!-- ``` -->


